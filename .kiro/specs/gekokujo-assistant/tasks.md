# Implementation Plan: 下克上小助手

## Overview

本实现计划将下克上小助手系统分解为可执行的编码任务。采用TypeScript全栈开发，前端使用React，后端使用Node.js + Express，数据存储使用JSON文件（便于分享和部署）。

## Tasks

- [x] 1. 项目初始化与基础架构
  - [x] 1.1 创建项目结构和配置文件
    - 初始化npm项目，配置TypeScript
    - 创建前端(React)和后端(Express)目录结构
    - 配置构建工具和开发服务器
    - _Requirements: 13.1_

  - [x] 1.2 实现数据存储层
    - 创建JSON文件存储结构
    - 实现数据读写工具函数
    - 实现数据快照功能（用于回溯）
    - _Requirements: 9.6, 9.7_

  - [x] 1.3 编写数据存储层属性测试
    - **Property 10: 数据回溯一致性**
    - **Validates: Requirements 9.7**

- [x] 2. 核心计算引擎
  - [x] 2.1 实现表面石高计算
    - 实现领地石高汇总
    - 实现特产石高计算
    - 实现领内财产（整合奖励）计算
    - 实现加成系数计算
    - _Requirements: 2.3, 11.1_

  - [x] 2.2 编写表面石高计算属性测试
    - **Property 4: 表面石高计算正确性**
    - **Validates: Requirements 2.3, 11.1**

  - [x] 2.3 实现收入计算
    - 实现收入公式：表面石高 × 税率 × 0.4
    - _Requirements: 2.2, 11.2_

  - [x] 2.4 编写收入计算属性测试
    - **Property 5: 收入计算正确性**
    - **Validates: Requirements 2.2, 11.2**

  - [x] 2.5 实现士兵上限计算
    - 根据税率计算士兵招募上限
    - 税率40%:×230, 60%:×200, 80%:×180
    - _Requirements: 11.3_

  - [x] 2.6 编写士兵上限计算属性测试
    - **Property 6: 士兵上限计算正确性**
    - **Validates: Requirements 11.3**

  - [x] 2.7 实现士兵维持比计算
    - 计算维持比公式
    - 实现区间效果查询（加成系数、自然增长率）
    - _Requirements: 11.4_

  - [x] 2.8 编写士兵维持比属性测试
    - **Property 7: 士兵维持比区间效果**
    - **Validates: Requirements 11.4**

  - [x] 2.9 实现维护费计算
    - 步卒、战马、铁炮、大筒维护费
    - 军团额外费用
    - 武士俸禄
    - 武备等级维护费修正
    - _Requirements: 11.5, 11.6, 11.7_

  - [x] 2.10 编写维护费计算属性测试
    - **Property 9: 维护费计算正确性**
    - **Validates: Requirements 11.5, 11.6, 11.7**

- [x] 3. Checkpoint - 核心计算引擎验证
  - 确保所有计算引擎测试通过，如有问题请询问用户

- [x] 4. 认证与权限系统
  - [x] 4.1 实现认证服务
    - 实现代码验证逻辑
    - 实现管理员/玩家权限区分
    - 实现会话管理
    - _Requirements: 1.1, 1.2, 1.3, 1.4_

  - [x] 4.2 实现权限检查中间件
    - 管理员权限检查
    - 玩家势力数据隔离
    - _Requirements: 1.5, 1.6_

  - [x] 4.3 编写权限隔离属性测试
    - **Property 1: 权限隔离**
    - **Validates: Requirements 1.3, 1.6**

- [x] 5. 势力服务与仪表盘
  - [x] 5.1 实现势力数据服务
    - 获取势力完整数据
    - 获取势力列表（管理员）
    - 更新势力代码
    - _Requirements: 2.1-2.9_

  - [x] 5.2 实现前端登录页面
    - 代码输入框和确认按钮
    - 错误提示显示
    - _Requirements: 1.1, 1.4_

  - [x] 5.3 实现前端仪表盘组件
    - 势力基础信息显示
    - 武库数据显示
    - 士兵数据显示
    - 增益列表显示
    - _Requirements: 2.1-2.9_

- [x] 6. 详细信息列表模块
  - [x] 6.1 实现通用列表组件
    - 最多显示10条数据
    - 滚动时表头固定
    - 数据行与表头对齐
    - _Requirements: 12.2, 12.3, 12.4_

  - [x] 6.2 实现领地列表
    - 显示郡名、令制国、石高、城池、特产、驻扎军团
    - _Requirements: 3.1_

  - [x] 6.3 实现武士列表
    - 显示姓名、类型、武功、文治、状态、行动力
    - _Requirements: 3.2_

  - [x] 6.4 实现外交关系列表
    - 显示目标势力和当前关系
    - _Requirements: 3.3_

  - [x] 6.5 实现军团列表
    - 显示军团名称、将领、人数、装备、位置
    - 点击展开管理菜单
    - _Requirements: 3.4, 3.6_

- [x] 7. 士兵招募功能
  - [x] 7.1 实现招募服务
    - 验证招募数量不超过上限
    - 更新闲置士兵和可招募额度
    - _Requirements: 4.1-4.5_

  - [x] 7.2 实现招募弹窗组件
    - 滑动条+数字输入框组合
    - 双向联动
    - 边界限制
    - _Requirements: 12.5, 12.6, 12.7, 12.8_

  - [x] 7.3 编写数值输入边界属性测试
    - **Property 13: 数值输入边界**
    - **Validates: Requirements 12.7, 12.8**

- [x] 8. 军团管理功能
  - [x] 8.1 实现军团创建服务
    - 军团名称验证（1-8个简体中文字符）
    - 将领冲突检测和处理
    - 资源扣除逻辑
    - _Requirements: 5.1-5.10_

  - [x] 8.2 编写军团名称验证属性测试
    - **Property 12: 军团名称验证**
    - **Validates: Requirements 5.2, 5.7**

  - [x] 8.3 编写将领唯一性属性测试
    - **Property 2: 将领唯一性约束**
    - **Validates: Requirements 5.9, 5.10**

  - [x] 8.4 实现军团解散服务
    - 资源返还库存
    - 将领状态更新
    - _Requirements: 6.1, 6.2_

  - [x] 8.5 实现军团编辑服务
    - 编辑人数（含解散判断）
    - 编辑装备
    - _Requirements: 6.3, 6.4, 6.5, 6.6_

  - [x] 8.6 编写资源守恒属性测试
    - **Property 3: 资源守恒**
    - **Validates: Requirements 4.4, 6.2, 6.3, 6.5**

  - [x] 8.7 实现军团创建弹窗组件
    - 军团名称输入和验证
    - 将领下拉选择
    - 人数和装备滑条
    - 位置选择
    - 将领冲突处理弹窗
    - _Requirements: 5.1-5.10_

  - [x] 8.8 实现军团管理菜单组件
    - 解散、编辑人数、编辑装备按钮
    - 确认弹窗
    - _Requirements: 6.1-6.6_

- [x] 9. Checkpoint - 军团功能验证
  - 确保所有军团相关测试通过，如有问题请询问用户

- [x] 10. 投资系统
  - [x] 10.1 实现投资判定引擎
    - 属性修正系数计算
    - 成功率计算（锁定5%-95%）
    - D100随机判定
    - 点数计算（大成功/成功/失败）
    - _Requirements: 7.5, 7.6_

  - [x] 10.2 编写投资判定属性测试
    - **Property 8: 投资判定正确性**
    - **Validates: Requirements 7.5, 7.6**

  - [x] 10.3 实现四大投资子系统
    - 农业系统（文治属性，5000石/次，5点基础）
    - 商业系统（智略属性，特殊判定流程）
    - 水军系统（武功属性，8000石/次，4点基础）
    - 武备系统（武勇属性，4000石/次，6点基础）
    - _Requirements: 7.1-7.8_

  - [x] 10.4 实现投资界面组件
    - 库存和点数显示
    - 投资项目选择
    - 预计成功率和效果显示
    - 确认弹窗
    - _Requirements: 7.1-7.4_

- [x] 11. 管理员数据管理
  - [x] 11.1 实现郡国数据管理API
    - CRUD操作
    - 搜索筛选
    - _Requirements: 8.1_

  - [x] 11.2 实现势力代码管理API
    - 代码修改
    - _Requirements: 8.2_

  - [x] 11.3 实现全军团一览API
    - 汇总所有军团
    - 编辑和删除
    - _Requirements: 8.3_

  - [x] 11.4 实现特产系统配置API
    - 特产CRUD
    - _Requirements: 8.4_

  - [x] 11.5 实现管理员数据管理界面
    - 郡国数据表格（可编辑）
    - 势力代码管理表
    - 全军团一览表
    - 特产配置页面
    - _Requirements: 8.1-8.5_

- [x] 12. 游戏进程控制
  - [x] 12.1 实现下一年结算服务
    - 扣除维护费
    - 更新基础石高（自然增长）
    - 重置武士行动力
    - 创建数据快照
    - _Requirements: 9.1, 9.2_

  - [x] 12.2 实现锁定/解锁功能
    - 锁定状态管理
    - 玩家操作拦截
    - _Requirements: 9.3, 9.4_

  - [x] 12.3 实现记账与推演功能
    - 日志录入
    - 日志筛选和删除
    - _Requirements: 9.5_

  - [x] 12.4 实现操作记录与回溯
    - 记录玩家和管理员操作
    - 保留最近100条
    - 跳转至此功能（最近20条）
    - _Requirements: 9.6, 9.7_

  - [x] 12.5 实现游戏进程控制界面
    - 下一年按钮和确认
    - 锁定按钮
    - 记账推演页面
    - 操作记录列表
    - _Requirements: 9.1-9.7_

- [x] 13. 数据导入功能
  - [x] 13.1 实现数据导入解析器
    - 郡国数据解析
    - 军团数据解析
    - 势力数据解析
    - _Requirements: 10.1-10.4_

  - [x] 13.2 实现数据导入界面
    - 类型选择
    - 纯文本粘贴区域
    - 解析和保存
    - _Requirements: 10.1-10.4_

- [x] 14. 错误报告系统
  - [x] 14.1 实现操作记录追踪
    - 记录玩家每步操作
    - 保留最近五步
    - _Requirements: 14.2, 14.5_

  - [x] 14.2 实现错误报告服务
    - 手动报告接口
    - 自动报告接口
    - 报告存储
    - _Requirements: 14.1-14.5_

  - [x] 14.3 编写错误报告完整性属性测试
    - **Property 11: 错误报告完整性**
    - **Validates: Requirements 14.2, 14.3, 14.5**

  - [x] 14.4 实现玩家端报错按钮
    - 报错按钮UI
    - 错误弹窗自动触发
    - _Requirements: 14.1, 14.4_

  - [x] 14.5 实现管理员错误报告界面
    - 错误报告列表
    - 按时间、玩家筛选
    - 标记已处理
    - _Requirements: 14.6, 14.7, 14.8, 14.9_

- [x] 15. Checkpoint - 完整功能验证
  - 确保所有测试通过，如有问题请询问用户

- [x] 16. 集成与部署
  - [x] 16.1 前后端集成
    - API路由配置
    - 前端API调用封装
    - 错误处理统一
    - _Requirements: 13.1_

  - [x] 16.2 URL分享功能
    - 生成可分享链接
    - 链接访问验证
    - _Requirements: 13.2, 13.3_

  - [x] 16.3 最终测试和优化
    - 端到端测试
    - 性能优化
    - 简体中文编码验证
    - _Requirements: 12.1_

## Notes

- All tasks are required for comprehensive testing
- Each task references specific requirements for traceability
- Checkpoints ensure incremental validation
- Property tests validate universal correctness properties
- Unit tests validate specific examples and edge cases
- 使用TypeScript全栈开发，前端React，后端Express
- 数据存储使用JSON文件，便于分享和部署
