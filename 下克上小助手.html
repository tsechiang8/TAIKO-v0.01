<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‹å…‹ä¸Šå°åŠ©æ‰‹v0.01å†…æµ‹ç‰ˆ - è·¯äººå°ç‹¼ å·¨çŒ®</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-color: #8B4513;
            --secondary-color: #D2691E;
            --bg-color: #FDF5E6;
            --text-color: #2F1810;
            --border-color: #A0522D;
            --header-bg: #654321;
            --success-color: #228B22;
            --danger-color: #B22222;
            --warning-color: #DAA520;
        }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #FDF5E6 0%, #DEB887 100%);
            min-height: 100vh;
            color: var(--text-color);
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .login-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            border: 3px solid var(--primary-color);
        }
        .login-box h1 { color: var(--primary-color); margin-bottom: 10px; font-size: 28px; }
        .login-box .subtitle { color: var(--secondary-color); margin-bottom: 30px; font-size: 14px; }
        .login-box input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
        }
        .login-box input:focus { outline: none; border-color: var(--primary-color); }
        .login-box button {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
        }
        .login-box button:hover { transform: translateY(-2px); }
        .main-container { display: none; min-height: 100vh; }
        .top-nav {
            background: linear-gradient(135deg, var(--header-bg), var(--primary-color));
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .top-nav h1 { font-size: 22px; }
        .top-nav .user-info { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .top-nav .user-info span { background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 15px; font-size: 14px; }
        .top-nav button { padding: 8px 16px; background: var(--danger-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; }
        .top-nav button:hover { opacity: 0.9; }
        .top-nav button.btn-success { background: var(--success-color); }
        .top-nav button.btn-warning { background: var(--warning-color); }
        .content { padding: 20px; max-width: 1800px; margin: 0 auto; }
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body { padding: 15px; }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-color);
            border-radius: 5px;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .info-item .label { color: var(--primary-color); font-weight: bold; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        th { background: var(--header-bg); color: white; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: var(--bg-color); }
        .table-scroll { max-height: 400px; overflow-y: auto; }
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 1px; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-success { background: var(--success-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-warning { background: var(--warning-color); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { opacity: 0.85; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; max-width: 700px; width: 95%; max-height: 85vh; overflow-y: auto; }
        .modal-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 15px 20px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-weight: bold; color: var(--primary-color); font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-color); }
        .form-group.error input { border-color: var(--danger-color); animation: shake 0.3s; }
        .form-group .error-msg { color: var(--danger-color); font-size: 11px; display: none; }
        .form-group.error .error-msg { display: block; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        .slider-group { display: flex; align-items: center; gap: 10px; }
        .slider-group input[type="range"] { flex: 1; }
        .slider-group input[type="number"] { width: 80px; text-align: center; }
        .admin-tabs { display: flex; background: var(--header-bg); flex-wrap: wrap; }
        .admin-tab { padding: 12px 18px; background: transparent; color: rgba(255,255,255,0.7); border: none; cursor: pointer; font-size: 13px; }
        .admin-tab:hover { background: rgba(255,255,255,0.1); color: white; }
        .admin-tab.active { background: white; color: var(--primary-color); }
        .admin-panel { display: none; background: white; padding: 15px; border: 1px solid var(--border-color); border-top: none; }
        .admin-panel.active { display: block; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .toolbar input, .toolbar select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .buff-tag { display: inline-block; background: var(--success-color); color: white; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin: 1px; }
        .level-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .level-0 { background: #dc3545; color: white; }
        .level-1 { background: #6c757d; color: white; }
        .level-2 { background: #17a2b8; color: white; }
        .level-3 { background: #28a745; color: white; }
        .level-4 { background: #007bff; color: white; }
        .level-5 { background: #6f42c1; color: white; }
        .level-6 { background: #fd7e14; color: white; }
        .level-7 { background: #e83e8c; color: white; }
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-bar .fill { height: 100%; background: var(--success-color); transition: width 0.3s; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--secondary-color); border-radius: 4px; }
        @media (max-width: 1200px) { .grid-4, .grid-3 { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1>âš”ï¸ ä¸‹å…‹ä¸Šå°åŠ©æ‰‹</h1>
            <p class="subtitle">v0.01å†…æµ‹ç‰ˆ - è·¯äººå°ç‹¼ å·¨çŒ®</p>
            <input type="text" id="loginCode" placeholder="è¯·è¾“å…¥ç™»å½•ä»£ç " autocomplete="off">
            <button onclick="handleLogin()">è¿›å…¥æ¸¸æˆ</button>
        </div>
    </div>
    <div class="main-container" id="mainContainer">
        <div class="top-nav">
            <h1>âš”ï¸ ä¸‹å…‹ä¸Šå°åŠ©æ‰‹ v0.01</h1>
            <div class="user-info">
                <span id="currentUser">å½“å‰ç”¨æˆ·ï¼š-</span>
                <span id="currentYear">å¹´ä»½ï¼š1560å¹´</span>
                <button class="btn-success" onclick="copyShareLink()" id="shareLinkBtn">å¤åˆ¶è”ç½‘é“¾æ¥</button>
                <button class="btn-warning" onclick="nextYear()" id="nextYearBtn" style="display:none;">ä¸‹ä¸€å¹´</button>
                <button onclick="handleLogout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
        <div class="content" id="playerView" style="display: none;"></div>
        <div class="content" id="adminView" style="display: none;">
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('territories')">éƒ¡å›½æ•°æ®ç®¡ç†</button>
                <button class="admin-tab" onclick="switchAdminTab('factions')">åŠ¿åŠ›ç®¡ç†</button>
                <button class="admin-tab" onclick="switchAdminTab('products')">ç‰¹äº§å¯¹ç…§è¡¨</button>
                <button class="admin-tab" onclick="switchAdminTab('armies')">å…¨å†›å›¢ä¸€è§ˆ</button>
                <button class="admin-tab" onclick="switchAdminTab('chronicle')">è®°è´¦ä¸æ¨æ¼”</button>
                <button class="admin-tab" onclick="switchAdminTab('investment')">æŠ•èµ„ç³»ç»Ÿ</button>
                <button class="admin-tab" onclick="switchAdminTab('import')">æ•°æ®å¯¼å…¥</button>
                <button class="admin-tab" onclick="switchAdminTab('logs')">æ“ä½œè®°å½•</button>
                <button class="admin-tab" onclick="switchAdminTab('backup')">æ•°æ®å¤‡ä»½</button>
            </div>
            <div class="admin-panel active" id="panel-territories"></div>
            <div class="admin-panel" id="panel-factions"></div>
            <div class="admin-panel" id="panel-products"></div>
            <div class="admin-panel" id="panel-armies"></div>
            <div class="admin-panel" id="panel-chronicle"></div>
            <div class="admin-panel" id="panel-investment"></div>
            <div class="admin-panel" id="panel-import"></div>
            <div class="admin-panel" id="panel-logs"></div>
            <div class="admin-panel" id="panel-backup"></div>
        </div>
    </div>
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ ‡é¢˜</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>
<script>

// ==================== æ•°æ®ç»“æ„ ====================
const DEFAULT_DATA = {
    version: '0.02',
    currentYear: 1560,
    // ç‰¹äº§å¯¹ç…§è¡¨
    products: {
        'é‡‘å±±': { name: 'é‡‘å±±', koku: 5000, horses: 0, soldiers: 0, kokuBonus: 10, effect: 'äº§å‡ºé»„é‡‘' },
        'é“¶å±±': { name: 'é“¶å±±', koku: 3000, horses: 0, soldiers: 0, kokuBonus: 5, effect: 'äº§å‡ºç™½é“¶' },
        'é“çŸ¿': { name: 'é“çŸ¿', koku: 1000, horses: 0, soldiers: 0, kokuBonus: 0, effect: 'é“ç‚®ç”Ÿäº§æˆæœ¬-20%' },
        'é©¬åœº': { name: 'é©¬åœº', koku: 500, horses: 50, soldiers: 0, kokuBonus: 0, effect: 'æ¯å¹´äº§å‡ºæˆ˜é©¬' },
        'è‰¯ç”°': { name: 'è‰¯ç”°', koku: 2000, horses: 0, soldiers: 500, kokuBonus: 3, effect: 'å¢åŠ å£«å…µä¸Šé™' },
        'æ¸¯å£': { name: 'æ¸¯å£', koku: 3000, horses: 0, soldiers: 0, kokuBonus: 8, effect: 'æµ·ä¸Šè´¸æ˜“æ”¶å…¥' },
        'æ¸©æ³‰': { name: 'æ¸©æ³‰', koku: 1500, horses: 0, soldiers: 0, kokuBonus: 2, effect: 'å£«æ°”æ¢å¤åŠ å¿«' },
        'å•†ä¸šè¡—': { name: 'å•†ä¸šè¡—', koku: 2500, horses: 0, soldiers: 0, kokuBonus: 6, effect: 'å•†ä¸šç¹è£' }
    },
    // ä»¤åˆ¶å›½çŸ³é«˜æ•°æ®ï¼ˆç”¨äºåˆ¤æ–­æ•´åˆå¥–åŠ±ï¼‰
    provinces: {
        'è‹¥ç‹­å›½': { koku: 85000, code: 'RUXI' },
        'è¶Šå‰å›½': { koku: 495000, code: 'YUEQI' },
        'åŠ è´ºå›½': { koku: 355000, code: 'JIAGE' },
        'èƒ½ç™»å›½': { koku: 210000, code: 'NEDE' },
        'è¶Šä¸­å›½': { koku: 380000, code: 'YUEZH' },
        'è¶Šåå›½': { koku: 390000, code: 'YUEHO' },
        'ä½æ¸¡å›½': { koku: 17000, code: 'ZUOD' },
        'å°¾å¼ å›½': { koku: 571000, code: 'WEIZH' },
        'ä¸‰æ²³å›½': { koku: 290000, code: 'SAHE' },
        'è¿œæ±Ÿå›½': { koku: 255000, code: 'YUJI' },
        'ï¿½çš„æ²³å›½': { koku: 151000, code: 'TUHE' },
        'ä¼Šè±†å›½': { koku: 70000, code: 'YIDO' },
        'ç”²æ–å›½': { koku: 227000, code: 'JIABE' },
        'ç›¸æ¨¡å›½': { koku: 194000, code: 'XIAM' },
        'æ­¦è—å›½': { koku: 667000, code: 'WUCA' },
        'å®‰æˆ¿å›½': { koku: 43000, code: 'ANFA' },
        'ä¸Šæ€»å›½': { koku: 378000, code: 'SHZO' },
        'ä¸‹æ€»å›½': { koku: 390000, code: 'XIAZO' },
        'å¸¸é™†å›½': { koku: 530000, code: 'CHAL' },
        'è¿‘æ±Ÿå›½': { koku: 775000, code: 'JINJI' },
        'ç¾æµ“å›½': { koku: 540000, code: 'MEIN' },
        'é£é©’å›½': { koku: 38000, code: 'FEIT' },
        'ä¿¡æµ“å›½': { koku: 408000, code: 'XINN' },
        'ä¸Šé‡å›½': { koku: 496000, code: 'SHYE' },
        'ä¸‹é‡å›½': { koku: 374000, code: 'XIAYE' },
        'ï¿½çš„å¥¥å›½': { koku: 1670000, code: 'TUAO' },
        'å‡ºç¾½å›½': { koku: 318000, code: 'CHUY' },
        'å±±åŸå›½': { koku: 225000, code: 'SHCH' },
        'å¤§å’Œå›½': { koku: 449000, code: 'DAHE' },
        'æ²³å†…å›½': { koku: 242000, code: 'HEN' },
        'å’Œæ³‰å›½': { koku: 143000, code: 'HEQU' },
        'ï¿½çš„æ´¥å›½': { koku: 356000, code: 'TUJIN' },
        'ä¸¹æ³¢å›½': { koku: 263000, code: 'DANB' },
        'ä¸¹åå›½': { koku: 111000, code: 'DANH' },
        'ä½†é©¬å›½': { koku: 113000, code: 'DANM' },
        'å› å¹¡å›½': { koku: 89000, code: 'YINF' },
        'ä¼¯è€†å›½': { koku: 100000, code: 'BOQI' },
        'å‡ºäº‘å›½': { koku: 186000, code: 'CHUY' },
        'çŸ³è§å›½': { koku: 112000, code: 'SHIJ' },
        'ï¿½çš„å²å›½': { koku: 5000, code: 'TUQI' },
        'æ’­ç£¨å›½': { koku: 359000, code: 'BOM' },
        'ç¾ä½œå›½': { koku: 186000, code: 'MEIZ' },
        'å¤‡å‰å›½': { koku: 224000, code: 'BEIQ' },
        'å¤‡ä¸­å›½': { koku: 178000, code: 'BEIZH' },
        'å¤‡åå›½': { koku: 186000, code: 'BEIH' },
        'å®‰è‰ºå›½': { koku: 194000, code: 'ANYI' },
        'å‘¨é˜²å›½': { koku: 168000, code: 'ZHOUF' },
        'é•¿é—¨å›½': { koku: 133000, code: 'CHAM' },
        'çºªä¼Šå›½': { koku: 245000, code: 'JIYI' },
        'ï¿½çš„è·¯å›½': { koku: 186000, code: 'TUL' },
        'é˜¿æ³¢å›½': { koku: 184000, code: 'AB' },
        'èµå²å›½': { koku: 126000, code: 'ZANQ' },
        'ä¼Šäºˆå›½': { koku: 367000, code: 'YIY' },
        'åœŸä½å›½': { koku: 98000, code: 'TUZUO' },
        'ç­‘å‰å›½': { koku: 326000, code: 'ZHUQI' },
        'ç­‘åå›½': { koku: 266000, code: 'ZHUH' },
        'ä¸°å‰å›½': { koku: 140000, code: 'FEQI' },
        'ä¸°åå›½': { koku: 418000, code: 'FEHO' },
        'è‚¥å‰å›½': { koku: 309000, code: 'FEIQI' },
        'è‚¥åå›½': { koku: 341000, code: 'FEIH' },
        'æ—¥å‘å›½': { koku: 120000, code: 'RIXI' },
        'å¤§éš…å›½': { koku: 178000, code: 'DAY' },
        'è¨æ‘©å›½': { koku: 283000, code: 'SAM' },
        'çš„ï¿½çš„å›½': { koku: 28000, code: 'TUTU' },
        'å¯¹é©¬å›½': { koku: 21000, code: 'DUIM' },
        'ä¼Šè´ºå›½': { koku: 100000, code: 'YIGA' },
        'ä¼ŠåŠ¿å›½': { koku: 567000, code: 'YISH' },
        'å¿—æ‘©å›½': { koku: 18000, code: 'ZHIM' }
    },
    // åŠ¿åŠ›æ•°æ®
    factions: {
        'oda': {
            id: 'oda',
            name: 'ç»‡ç”°å®¶',
            lord: 'ç»‡ç”°ä¿¡é•¿',
            code: 'oda',
            taxRate: 60,
            industryKoku: 10000,
            agriculture: { points: 30, level: 2 },
            commerce: { points: 0 },
            navy: { points: 15, level: 1 },
            armament: { points: 25, level: 2 },
            arsenal: { guns: 100, horses: 50, cannons: 5 },
            soldiers: { idle: 500, total: 0 },
            money: 50000,
            buffs: [],
            samurai: [
                { name: 'æŸ´ç”°èƒœå®¶', type: 'çŒ›å°†', martial: 85, civil: 45 },
                { name: 'ä¸¹ç¾½é•¿ç§€', type: 'æ™ºå°†', martial: 65, civil: 80 },
                { name: 'ç¾½æŸ´ç§€å‰', type: 'æ™ºå°†', martial: 70, civil: 90 },
                { name: 'å¾·å·å®¶åº·', type: 'çŒ›å°†', martial: 80, civil: 75 }
            ],
            diplomacy: [
                { target: 'ä»Šå·å®¶', relation: 'æ•Œå¯¹' },
                { target: 'æ­¦ç”°å®¶', relation: 'ä¸­ç«‹' },
                { target: 'æµ…äº•å®¶', relation: 'å‹å¥½' }
            ]
        },
        'takeda': {
            id: 'takeda',
            name: 'æ­¦ç”°å®¶',
            lord: 'æ­¦ç”°ä¿¡ç„',
            code: 'takeda',
            taxRate: 60,
            industryKoku: 10000,
            agriculture: { points: 45, level: 3 },
            commerce: { points: 0 },
            navy: { points: 5, level: 0 },
            armament: { points: 40, level: 3 },
            arsenal: { guns: 30, horses: 200, cannons: 2 },
            soldiers: { idle: 800, total: 0 },
            money: 80000,
            buffs: [],
            samurai: [
                { name: 'å±±å¿æ˜Œæ™¯', type: 'çŒ›å°†', martial: 90, civil: 40 },
                { name: 'é©¬åœºä¿¡æ˜¥', type: 'çŒ›å°†', martial: 85, civil: 50 }
            ],
            diplomacy: [
                { target: 'ä¸Šæ‰å®¶', relation: 'æ•Œå¯¹' },
                { target: 'ä»Šå·å®¶', relation: 'åŒç›Ÿ' }
            ]
        }
    },
    // é¢†åœ°æ•°æ®
    territories: [
        {
            code: 'WEIZH01',
            province: 'å°¾å¼ å›½',
            name: 'æ˜¥æ—¥äº•éƒ¡',
            castle: 'æ¸…æ´²åŸ',
            castleLevel: 5,
            baseKoku: 50000,
            product1: 'å•†ä¸šè¡—',
            product2: '',
            product3: '',
            developableProduct: 'æ¸¯å£',
            owner: 'oda',
            garrison: 'ç»‡ç”°æœ¬é˜Ÿ',
            description: 'å°¾å¼ å›½çš„ä¸­å¿ƒåœ°å¸¦ï¼Œç»‡ç”°å®¶çš„æ ¹æ®åœ°ã€‚æ¸…æ´²åŸæ˜¯ç»‡ç”°ä¿¡é•¿ç»Ÿä¸€å°¾å¼ åçš„å±…åŸã€‚'
        },
        {
            code: 'WEIZH02',
            province: 'å°¾å¼ å›½',
            name: 'çˆ±çŸ¥éƒ¡',
            castle: 'é‚£å¤é‡åŸ',
            castleLevel: 4,
            baseKoku: 35000,
            product1: 'è‰¯ç”°',
            product2: '',
            product3: '',
            developableProduct: 'é©¬åœº',
            owner: 'oda',
            garrison: '',
            description: 'ç»‡ç”°ä¿¡é•¿çš„å‡ºç”Ÿåœ°ï¼Œå…·æœ‰é‡è¦çš„æˆ˜ç•¥æ„ä¹‰ã€‚'
        },
        {
            code: 'JIABE01',
            province: 'ç”²æ–å›½',
            name: 'å±±æ¢¨éƒ¡',
            castle: 'çš„åºœåŸ',
            castleLevel: 6,
            baseKoku: 40000,
            product1: 'é‡‘å±±',
            product2: 'é©¬åœº',
            product3: '',
            developableProduct: '',
            owner: 'takeda',
            garrison: 'æ­¦ç”°éª‘å…µé˜Ÿ',
            description: 'æ­¦ç”°å®¶çš„æœ¬æ®åœ°ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„é‡‘çŸ¿èµ„æºã€‚'
        }
    ],
    // å†›å›¢æ•°æ®
    armies: [
        { id: 1, faction: 'oda', name: 'ç»‡ç”°æœ¬é˜Ÿ', general: 'æŸ´ç”°èƒœå®¶', soldiers: 300, guns: 50, horses: 20, cannons: 2, location: 'æ˜¥æ—¥äº•éƒ¡' },
        { id: 2, faction: 'takeda', name: 'æ­¦ç”°éª‘å…µé˜Ÿ', general: 'å±±å¿æ˜Œæ™¯', soldiers: 500, guns: 10, horses: 150, cannons: 0, location: 'å±±æ¢¨éƒ¡' }
    ],
    chronicles: [],
    operationLogs: [],
    nextArmyId: 3,
    nextChronicleId: 1
};

// ==================== å…¨å±€çŠ¶æ€ ====================
let gameData = null;
let currentUser = null;
let currentFaction = null;
let isAdmin = false;

// ==================== åˆå§‹åŒ– ====================
function init() {
    loadData();
    checkUrlLogin();
}

function loadData() {
    const saved = localStorage.getItem('gekokujo_data_v2');
    if (saved) {
        try {
            gameData = JSON.parse(saved);
            // ç¡®ä¿æ–°å­—æ®µå­˜åœ¨
            if (!gameData.products) gameData.products = DEFAULT_DATA.products;
            if (!gameData.provinces) gameData.provinces = DEFAULT_DATA.provinces;
        } catch (e) {
            gameData = JSON.parse(JSON.stringify(DEFAULT_DATA));
        }
    } else {
        gameData = JSON.parse(JSON.stringify(DEFAULT_DATA));
    }
}

function saveData() {
    localStorage.setItem('gekokujo_data_v2', JSON.stringify(gameData));
}

function checkUrlLogin() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (code) {
        document.getElementById('loginCode').value = code;
        handleLogin();
    }
}

// ==================== ç™»å½•ç³»ç»Ÿ ====================
function handleLogin() {
    const code = document.getElementById('loginCode').value.trim();
    if (!code) { alert('è¯·è¾“å…¥ç™»å½•ä»£ç '); return; }
    if (code === 'admin') {
        isAdmin = true;
        currentUser = 'ç®¡ç†å‘˜';
        currentFaction = null;
        showMainInterface();
        addOperationLog('ç®¡ç†å‘˜', 'ç™»å½•ç³»ç»Ÿ');
        return;
    }
    for (const fid in gameData.factions) {
        if (gameData.factions[fid].code === code) {
            isAdmin = false;
            currentUser = gameData.factions[fid].name;
            currentFaction = fid;
            showMainInterface();
            addOperationLog(gameData.factions[fid].name, 'ç™»å½•ç³»ç»Ÿ');
            return;
        }
    }
    alert('æ— æ•ˆçš„ç™»å½•ä»£ç ');
}

function handleLogout() {
    isAdmin = false;
    currentUser = null;
    currentFaction = null;
    document.getElementById('loginContainer').style.display = 'flex';
    document.getElementById('mainContainer').style.display = 'none';
    document.getElementById('loginCode').value = '';
}

function showMainInterface() {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('mainContainer').style.display = 'block';
    document.getElementById('currentUser').textContent = 'å½“å‰ç”¨æˆ·ï¼š' + currentUser;
    document.getElementById('currentYear').textContent = 'å¹´ä»½ï¼š' + gameData.currentYear + 'å¹´';
    document.getElementById('nextYearBtn').style.display = isAdmin ? 'inline-block' : 'none';
    if (isAdmin) {
        document.getElementById('adminView').style.display = 'block';
        document.getElementById('playerView').style.display = 'none';
        renderAdminView();
    } else {
        document.getElementById('adminView').style.display = 'none';
        document.getElementById('playerView').style.display = 'block';
        renderPlayerView();
    }
}

function addOperationLog(operator, content) {
    const log = { time: new Date().toLocaleString('zh-CN'), operator, content, snapshot: JSON.stringify(gameData) };
    gameData.operationLogs.unshift(log);
    if (gameData.operationLogs.length > 100) gameData.operationLogs = gameData.operationLogs.slice(0, 100);
    saveData();
}

function copyShareLink() {
    const url = window.location.href.split('?')[0];
    navigator.clipboard.writeText(url).then(() => {
        alert('è”ç½‘é“¾æ¥å·²å¤åˆ¶ï¼\\n\\nå°†æ­¤é“¾æ¥å‘é€ç»™ç©å®¶ï¼Œä»–ä»¬å¯ä»¥ç›´æ¥è®¿é—®å¹¶è¾“å…¥åŠ¿åŠ›ä»£ç ç™»å½•ã€‚\\n\\næ³¨æ„ï¼šæ•°æ®å­˜å‚¨åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œå¦‚éœ€å¤šäººå…±äº«æ•°æ®ï¼Œè¯·ä½¿ç”¨å¯¼å‡º/å¯¼å…¥åŠŸèƒ½ã€‚');
    }).catch(() => {
        prompt('è¯·å¤åˆ¶ä»¥ä¸‹é“¾æ¥ï¼š', url);
    });
}

// ==================== ç»æµè®¡ç®—æ ¸å¿ƒ ====================
// è·å–ç‰¹äº§æ•ˆæœ
function getProductEffect(productName) {
    return gameData.products[productName] || { koku: 0, horses: 0, soldiers: 0, kokuBonus: 0, effect: '' };
}

// è®¡ç®—åŠ¿åŠ›çš„é¢†åœ°çŸ³é«˜ï¼ˆåŸºç¡€çŸ³é«˜ä¹‹å’Œï¼‰
function calcTerritoryKoku(factionId) {
    return gameData.territories.filter(t => t.owner === factionId).reduce((sum, t) => sum + (t.baseKoku || 0), 0);
}

// è®¡ç®—ç‰¹äº§çŸ³é«˜
function calcProductKoku(factionId) {
    let total = 0;
    gameData.territories.filter(t => t.owner === factionId).forEach(t => {
        [t.product1, t.product2, t.product3].forEach(p => {
            if (p) total += getProductEffect(p).koku;
        });
    });
    return total;
}

// è®¡ç®—ç‰¹äº§å¸¦æ¥çš„é¢å¤–å£«å…µä¸Šé™
function calcProductSoldiers(factionId) {
    let total = 0;
    gameData.territories.filter(t => t.owner === factionId).forEach(t => {
        [t.product1, t.product2, t.product3].forEach(p => {
            if (p) total += getProductEffect(p).soldiers;
        });
    });
    return total;
}

// è®¡ç®—é¢†å†…è´¢äº§ï¼ˆæ•´åˆå¥–åŠ±ï¼‰
function calcIntegrationBonus(factionId) {
    let bonus = 0;
    const ownedTerritories = gameData.territories.filter(t => t.owner === factionId);
    const provinceMap = {};
    
    // ç»Ÿè®¡æ¯ä¸ªä»¤åˆ¶å›½çš„éƒ¡æ•°é‡å’ŒåŸºç¡€çŸ³é«˜
    ownedTerritories.forEach(t => {
        if (!provinceMap[t.province]) {
            provinceMap[t.province] = { count: 0, baseKoku: 0 };
        }
        provinceMap[t.province].count++;
        provinceMap[t.province].baseKoku += t.baseKoku || 0;
    });
    
    // æ£€æŸ¥æ˜¯å¦å®Œå…¨å é¢†ï¼ˆç®€åŒ–ï¼šå‡è®¾æ¯ä¸ªä»¤åˆ¶å›½æœ‰å›ºå®šéƒ¡æ•°ï¼Œè¿™é‡Œç”¨çŸ³é«˜åˆ¤æ–­ï¼‰
    for (const prov in provinceMap) {
        const provData = gameData.provinces[prov];
        if (provData) {
            // å¦‚æœå é¢†çš„åŸºç¡€çŸ³é«˜è¾¾åˆ°è¯¥å›½æ€»çŸ³é«˜çš„90%ä»¥ä¸Šï¼Œè§†ä¸ºå®Œå…¨å é¢†
            const allProvTerritories = gameData.territories.filter(t => t.province === prov);
            const totalProvKoku = allProvTerritories.reduce((s, t) => s + (t.baseKoku || 0), 0);
            if (provinceMap[prov].baseKoku >= totalProvKoku * 0.9 && totalProvKoku > 0) {
                if (provData.koku >= 300000) bonus += 20000; // 30ä¸‡çŸ³ä»¥ä¸Š+2ä¸‡
                else if (provData.koku >= 150000) bonus += 10000; // 15-30ä¸‡çŸ³+1ä¸‡
            }
        }
    }
    return bonus;
}

// è·å–å£«å…µç»´æŒæ¯”åŒºé—´æ•ˆæœ
function getSoldierRatioEffect(ratio) {
    if (ratio <= 0.20) return { kokuBonus: 0.12, growth: 0.03, name: 'ä¼‘å…»ç”Ÿæ¯' };
    if (ratio <= 0.45) return { kokuBonus: 0.06, growth: 0.01, name: 'æ­£å¸¸å‘å±•' };
    if (ratio <= 0.60) return { kokuBonus: 0, growth: -0.01, name: 'æ™®éåšæ³•' };
    if (ratio <= 0.80) return { kokuBonus: -0.10, growth: -0.02, name: 'ç©·å…µé»©æ­¦' };
    if (ratio <= 0.94) return { kokuBonus: -0.20, growth: -0.04, name: 'æš´å›' };
    return { kokuBonus: -0.30, growth: -0.08, name: 'é¢†åœ°å€’é€€' };
}

// è·å–å†œä¸šç­‰çº§æ•ˆæœ
function getAgricultureEffect(points) {
    if (points <= 0) return { level: 0, name: 'è’åºŸ', growth: -0.01, kokuBonus: -0.05 };
    if (points <= 15) return { level: 1, name: 'å¼€å¦', growth: 0, kokuBonus: 0 };
    if (points <= 30) return { level: 2, name: 'äº•ç”°', growth: 0.005, kokuBonus: 0 };
    if (points <= 50) return { level: 3, name: 'æ£€åœ°', growth: 0.01, kokuBonus: 0.02 };
    if (points <= 70) return { level: 4, name: 'æ²»æ°´', growth: 0.015, kokuBonus: 0.04 };
    if (points <= 85) return { level: 5, name: 'ä¸°é¥¶', growth: 0.02, kokuBonus: 0.06 };
    if (points <= 99) return { level: 6, name: 'å¤©åºœ', growth: 0.025, kokuBonus: 0.08 };
    return { level: 7, name: 'ç‘ç©—', growth: 0.03, kokuBonus: 0.10 };
}

// è·å–æ°´å†›ç­‰çº§
function getNavyLevel(points) {
    if (points <= 10) return { level: 0, name: 'çº¯çº¯æ¸”èˆ¹' };
    if (points <= 20) return { level: 1, name: 'å°é˜Ÿæ°´å†›' };
    if (points <= 35) return { level: 2, name: 'å¸¸è§„æ°´å†›' };
    if (points <= 50) return { level: 3, name: 'å¤§é˜Ÿæ°´å†›' };
    if (points <= 70) return { level: 4, name: 'é“ç”²èˆ¹' };
    if (points <= 85) return { level: 5, name: 'æ°´ä¸Šéœ¸ä¸»' };
    if (points <= 99) return { level: 6, name: 'ç–¾é£æ€’æ¶›' };
    return { level: 7, name: 'é®å¤©è”½æ—¥' };
}

// è·å–æ­¦å¤‡ç­‰çº§æ•ˆæœ
function getArmamentEffect(points) {
    if (points <= 0) return { level: 0, name: 'æœ½å', maintBonus: 0.20 };
    if (points <= 15) return { level: 1, name: 'æ™®é€š', maintBonus: 0 };
    if (points <= 30) return { level: 2, name: 'æ•´ä¿®', maintBonus: -0.05 };
    if (points <= 50) return { level: 3, name: 'ç²¾è‰¯', maintBonus: -0.10 };
    if (points <= 70) return { level: 4, name: 'å†›æ¢°', maintBonus: -0.20 };
    if (points <= 85) return { level: 5, name: 'ä¸¥æ•´', maintBonus: -0.30 };
    if (points <= 99) return { level: 6, name: 'å…µæ³•', maintBonus: -0.40 };
    return { level: 7, name: 'æ­¦åº“', maintBonus: -0.50 };
}

// è®¡ç®—åŠ¿åŠ›å®Œæ•´ç»æµæ•°æ®
function calcFactionEconomy(factionId) {
    const f = gameData.factions[factionId];
    if (!f) return null;
    
    const territoryKoku = calcTerritoryKoku(factionId);
    const productKoku = calcProductKoku(factionId);
    const integrationBonus = calcIntegrationBonus(factionId);
    const industryKoku = f.industryKoku || 10000;
    
    // è®¡ç®—å£«å…µç›¸å…³
    const armySoldiers = gameData.armies.filter(a => a.faction === factionId).reduce((s, a) => s + a.soldiers, 0);
    const totalSoldiers = (f.soldiers.idle || 0) + armySoldiers;
    const productSoldiers = calcProductSoldiers(factionId);
    
    // ç¨ç‡å¯¹åº”çš„æ‹›å‹Ÿç³»æ•°
    const taxRate = f.taxRate || 60;
    let recruitCoef = 200;
    if (taxRate <= 40) recruitCoef = 230;
    else if (taxRate >= 80) recruitCoef = 180;
    
    const maxSoldiers = Math.floor(territoryKoku / 10000 * recruitCoef) + productSoldiers;
    const soldierRatio = maxSoldiers > 0 ? totalSoldiers / maxSoldiers : 0;
    const ratioEffect = getSoldierRatioEffect(soldierRatio);
    const agriEffect = getAgricultureEffect(f.agriculture?.points || 0);
    
    // åŠ æˆç³»æ•° = å£«å…µç»´æŒæ¯”åŠ æˆ + å†œä¸šåŠ æˆ
    const bonusCoef = ratioEffect.kokuBonus + agriEffect.kokuBonus;
    
    // è¡¨é¢çŸ³é«˜
    const surfaceKoku = Math.floor(territoryKoku * (1 + bonusCoef) + productKoku + integrationBonus + industryKoku);
    
    // æ”¶å…¥ = è¡¨é¢çŸ³é«˜ Ã— ç¨ç‡ Ã— 0.4
    const income = Math.floor(surfaceKoku * (taxRate / 100) * 0.4);
    
    // ç»´æŠ¤è´¹è®¡ç®—
    const armamentEffect = getArmamentEffect(f.armament?.points || 0);
    const maintMultiplier = 1 + armamentEffect.maintBonus;
    
    let totalGuns = f.arsenal.guns || 0;
    let totalHorses = f.arsenal.horses || 0;
    let totalCannons = f.arsenal.cannons || 0;
    gameData.armies.filter(a => a.faction === factionId).forEach(a => {
        totalGuns += a.guns || 0;
        totalHorses += a.horses || 0;
        totalCannons += a.cannons || 0;
    });
    
    // åŸºç¡€ç»´æŠ¤è´¹
    const soldierMaint = totalSoldiers * 4;
    const horseMaint = Math.floor(totalHorses * 12 * maintMultiplier);
    const gunMaint = Math.floor(totalGuns * 3 * maintMultiplier);
    const cannonMaint = Math.floor(totalCannons * 8 * maintMultiplier);
    const armyExtraMaint = armySoldiers * 4; // å†›å›¢é¢å¤–è´¹ç”¨
    const samuraiMaint = (f.samurai?.length || 0) * 2000;
    
    const totalMaint = soldierMaint + horseMaint + gunMaint + cannonMaint + armyExtraMaint + samuraiMaint;
    const netIncome = income - totalMaint;
    
    return {
        territoryKoku,
        productKoku,
        integrationBonus,
        industryKoku,
        bonusCoef,
        surfaceKoku,
        taxRate,
        income,
        totalSoldiers,
        maxSoldiers,
        soldierRatio,
        ratioEffect,
        agriEffect,
        armamentEffect,
        totalMaint,
        netIncome,
        maintDetail: { soldierMaint, horseMaint, gunMaint, cannonMaint, armyExtraMaint, samuraiMaint }
    };
}

// ==================== å›åˆç»“ç®— ====================
function nextYear() {
    if (!confirm('ç¡®å®šè¦è¿›å…¥ä¸‹ä¸€å¹´å—ï¼Ÿ\\n\\nå°†è‡ªåŠ¨æ‰§è¡Œï¼š\\n1. æ ¹æ®å£«å…µç»´æŒæ¯”æ›´æ–°æ‰€æœ‰éƒ¡å›½çŸ³é«˜\\n2. è®¡ç®—å¹¶å‘æ”¾å¹´åº¦æ”¶å…¥\\n3. æ‰£é™¤æ‰€æœ‰ç»´æŠ¤è´¹ç”¨')) return;
    
    const results = [];
    
    for (const fid in gameData.factions) {
        const f = gameData.factions[fid];
        const eco = calcFactionEconomy(fid);
        if (!eco) continue;
        
        // è®¡ç®—è‡ªç„¶å¢é•¿ç‡
        const totalGrowth = eco.ratioEffect.growth + eco.agriEffect.growth;
        
        // æ›´æ–°æ‰€æœ‰é¢†åœ°çŸ³é«˜
        gameData.territories.filter(t => t.owner === fid).forEach(t => {
            const change = Math.floor((t.baseKoku || 0) * totalGrowth);
            t.baseKoku = Math.max(1000, (t.baseKoku || 0) + change);
        });
        
        // å‘æ”¾æ”¶å…¥ï¼Œæ‰£é™¤ç»´æŠ¤è´¹
        const oldMoney = f.money || 0;
        f.money = oldMoney + eco.netIncome;
        
        // æ£€æŸ¥å›ä¹±
        if (eco.soldierRatio > 1) {
            results.push(`ã€${f.name}ã€‘å£«å…µç»´æŒæ¯”è¶…è¿‡100%ï¼Œè§¦å‘å›ä¹±ï¼`);
        }
        
        results.push(`ã€${f.name}ã€‘æ”¶å…¥${eco.income}çŸ³ï¼Œæ”¯å‡º${eco.totalMaint}çŸ³ï¼Œå‡€æ”¶å…¥${eco.netIncome}çŸ³ï¼ŒçŸ³é«˜å¢é•¿ç‡${(totalGrowth * 100).toFixed(1)}%`);
    }
    
    gameData.currentYear++;
    document.getElementById('currentYear').textContent = 'å¹´ä»½ï¼š' + gameData.currentYear + 'å¹´';
    
    addOperationLog('ç®¡ç†å‘˜', `æ‰§è¡Œå¹´åº¦ç»“ç®—ï¼Œè¿›å…¥${gameData.currentYear}å¹´`);
    
    alert('å·²è¿›å…¥ ' + gameData.currentYear + ' å¹´\\n\\n' + results.join('\\n'));
    renderAdminView();
}

// ==================== æŠ•èµ„ç³»ç»Ÿ ====================
function doInvestment(factionId, type, samuraiName, targetCode) {
    const f = gameData.factions[factionId];
    if (!f) return { success: false, msg: 'åŠ¿åŠ›ä¸å­˜åœ¨' };
    
    const samurai = f.samurai.find(s => s.name === samuraiName);
    if (!samurai) return { success: false, msg: 'æ­¦å£«ä¸å­˜åœ¨' };
    
    let cost = 0, basePoints = 0, attr = 0;
    
    switch (type) {
        case 'agriculture':
            cost = 5000; basePoints = 5; attr = samurai.civil;
            break;
        case 'navy':
            cost = 8000; basePoints = 4; attr = samurai.martial;
            break;
        case 'armament':
            cost = 4000; basePoints = 6; attr = samurai.martial;
            break;
        default:
            return { success: false, msg: 'æœªçŸ¥æŠ•èµ„ç±»å‹' };
    }
    
    if ((f.money || 0) < cost) return { success: false, msg: 'èµ„é‡‘ä¸è¶³' };
    
    // ä¿®æ­£ç³»æ•°
    const modifier = 1 + (attr - 70) * 0.01;
    
    // æˆåŠŸç‡
    let successRate = 50 + (attr - 70);
    successRate = Math.max(5, Math.min(95, successRate));
    
    // D100åˆ¤å®š
    const roll = Math.floor(Math.random() * 100) + 1;
    let multiplier = 0.5; // å¤±è´¥
    let resultType = 'å¤±è´¥';
    
    if (roll < 5) {
        multiplier = 1.5;
        resultType = 'å¤§æˆåŠŸ';
    } else if (roll <= successRate) {
        multiplier = 1.0;
        resultType = 'æˆåŠŸ';
    }
    
    const points = Math.round(basePoints * modifier * multiplier);
    
    // æ‰£é™¤èµ„é‡‘
    f.money -= cost;
    
    // å¢åŠ ç‚¹æ•°
    if (!f[type]) f[type] = { points: 0 };
    f[type].points = Math.min(100, (f[type].points || 0) + points);
    
    saveData();
    
    return {
        success: true,
        resultType,
        roll,
        successRate,
        points,
        msg: `ã€${resultType}ã€‘æŠ•æ·${roll}ï¼ˆæˆåŠŸç‡${successRate}%ï¼‰ï¼Œè·å¾—${points}ç‚¹`
    };
}

function doCommerceInvestment(factionId, samuraiName, targetCode, investment) {
    const f = gameData.factions[factionId];
    if (!f) return { success: false, msg: 'åŠ¿åŠ›ä¸å­˜åœ¨' };
    
    const samurai = f.samurai.find(s => s.name === samuraiName);
    if (!samurai) return { success: false, msg: 'æ­¦å£«ä¸å­˜åœ¨' };
    
    const territory = gameData.territories.find(t => t.code === targetCode);
    if (!territory) return { success: false, msg: 'ç›®æ ‡éƒ¡å›½ä¸å­˜åœ¨' };
    
    if ((f.money || 0) < investment) return { success: false, msg: 'èµ„é‡‘ä¸è¶³' };
    
    // æˆåŠŸç‡ = (æ­¦å£«æ–‡æ²» - 50)% + (æŠ•å…¥èµ„é‡‘ / 1000)%
    let successRate = (samurai.civil - 50) + Math.floor(investment / 1000);
    successRate = Math.max(5, Math.min(95, successRate));
    
    const roll = Math.floor(Math.random() * 100) + 1;
    const isSuccess = roll <= successRate;
    
    // æ‰£é™¤èµ„é‡‘
    f.money -= investment;
    
    const hasProduct = territory.developableProduct && territory.developableProduct.trim() !== '';
    
    let msg = '';
    if (hasProduct && isSuccess) {
        // æƒ…å†µBï¼šæœ‰ç‰¹äº§ä¸”æˆåŠŸ
        const productName = territory.developableProduct;
        // æ·»åŠ åˆ°ç‰¹äº§åˆ—è¡¨
        if (!territory.product1) territory.product1 = productName;
        else if (!territory.product2) territory.product2 = productName;
        else if (!territory.product3) territory.product3 = productName;
        territory.developableProduct = '';
        msg = `å¼€å‘äº†ç‰¹äº§ã€${productName}ã€‘ï¼Œä¸‹æœˆèµ·å¼€å§‹äº§å‡ºæ”¶ç›Šï¼`;
    } else if (hasProduct && !isSuccess) {
        // æƒ…å†µCï¼šæœ‰ç‰¹äº§ä½†å¤±è´¥
        msg = `ä¼¼ä¹æœ‰å…³äºã€${territory.developableProduct}ã€‘çš„ä¼ é—»ï¼Œä½†æŠ•å…¥èµ„é‡‘ä¸è¶³ï¼Œæœªèƒ½å½¢æˆäº§ä¸šã€‚`;
    } else if (!hasProduct && isSuccess) {
        // æƒ…å†µAï¼šæ— ç‰¹äº§ä½†æˆåŠŸ
        msg = 'æ­¤åœ°å¹¶æ— æ–°å•†æœºã€‚';
    } else {
        // æƒ…å†µDï¼šæ— ç‰¹äº§ä¸”å¤±è´¥
        msg = 'æ²¡æœ‰æ‰“æ¢åˆ°æœ‰ä»·å€¼çš„æƒ…æŠ¥ã€‚';
    }
    
    saveData();
    return { success: true, roll, successRate, msg };
}

// ==================== ç©å®¶è§†å›¾ ====================
function renderPlayerView() {
    const f = gameData.factions[currentFaction];
    if (!f) return;
    
    const eco = calcFactionEconomy(currentFaction);
    const territories = gameData.territories.filter(t => t.owner === currentFaction);
    const armies = gameData.armies.filter(a => a.faction === currentFaction);
    const navyLevel = getNavyLevel(f.navy?.points || 0);
    
    document.getElementById('playerView').innerHTML = `
        <div class="grid-2">
            <div class="card">
                <div class="card-header">ğŸ“œ åŠ¿åŠ›ä¿¡æ¯</div>
                <div class="card-body">
                    <div class="info-item"><span class="label">åŠ¿åŠ›åç§°</span><span class="value">${f.name}</span></div>
                    <div class="info-item"><span class="label">å®¶ä¸»</span><span class="value">${f.lord}</span></div>
                    <div class="info-item"><span class="label">é¢†åœ°çŸ³é«˜</span><span class="value">${eco.territoryKoku.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">ç‰¹äº§çŸ³é«˜</span><span class="value">${eco.productKoku.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">æ•´åˆå¥–åŠ±</span><span class="value">${eco.integrationBonus.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">äº§ä¸šçŸ³é«˜</span><span class="value">${eco.industryKoku.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">åŠ æˆç³»æ•°</span><span class="value">${(eco.bonusCoef * 100).toFixed(1)}%</span></div>
                    <div class="info-item"><span class="label">è¡¨é¢çŸ³é«˜</span><span class="value" style="font-weight:bold;color:var(--primary-color)">${eco.surfaceKoku.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">ç¨ç‡</span><span class="value">${eco.taxRate}%</span></div>
                    <div class="info-item"><span class="label">å¹´æ”¶å…¥</span><span class="value">${eco.income.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">å¹´æ”¯å‡º</span><span class="value">${eco.totalMaint.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">å‡€æ”¶å…¥</span><span class="value" style="color:${eco.netIncome >= 0 ? 'green' : 'red'}">${eco.netIncome >= 0 ? '+' : ''}${eco.netIncome.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">ç°æœ‰èµ„é‡‘</span><span class="value">${(f.money || 0).toLocaleString()} çŸ³</span></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">âš”ï¸ å†›äº‹ä¸å‘å±•</div>
                <div class="card-body">
                    <div class="grid-2">
                        <div>
                            <h4 style="margin-bottom:8px;color:var(--primary-color)">æ­¦åº“</h4>
                            <div class="info-item"><span class="label">ğŸ”« é“ç‚®</span><span class="value">${f.arsenal.guns}</span></div>
                            <div class="info-item"><span class="label">ğŸ´ æˆ˜é©¬</span><span class="value">${f.arsenal.horses}</span></div>
                            <div class="info-item"><span class="label">ğŸ’£ å¤§ç­’</span><span class="value">${f.arsenal.cannons}</span></div>
                        </div>
                        <div>
                            <h4 style="margin-bottom:8px;color:var(--primary-color)">å£«å…µ</h4>
                            <div class="info-item"><span class="label">æ€»å…µåŠ›</span><span class="value">${eco.totalSoldiers}</span></div>
                            <div class="info-item"><span class="label">é—²ç½®å£«å…µ</span><span class="value">${f.soldiers.idle || 0}</span></div>
                            <div class="info-item"><span class="label">å£«å…µä¸Šé™</span><span class="value">${eco.maxSoldiers}</span></div>
                            <div class="info-item"><span class="label">ç»´æŒæ¯”</span><span class="value" style="color:${eco.soldierRatio > 0.6 ? 'red' : 'green'}">${(eco.soldierRatio * 100).toFixed(1)}% (${eco.ratioEffect.name})</span></div>
                        </div>
                    </div>
                    <hr style="margin:15px 0;border-color:#eee">
                    <div class="grid-2">
                        <div>
                            <div class="info-item"><span class="label">å†œä¸š</span><span class="value"><span class="level-badge level-${eco.agriEffect.level}">${eco.agriEffect.name}</span></span></div>
                            <div class="progress-bar"><div class="fill" style="width:${f.agriculture?.points || 0}%"></div></div>
                        </div>
                        <div>
                            <div class="info-item"><span class="label">æ°´å†›</span><span class="value"><span class="level-badge level-${navyLevel.level}">${navyLevel.name}</span></span></div>
                            <div class="progress-bar"><div class="fill" style="width:${f.navy?.points || 0}%"></div></div>
                        </div>
                        <div>
                            <div class="info-item"><span class="label">æ­¦å¤‡</span><span class="value"><span class="level-badge level-${eco.armamentEffect.level}">${eco.armamentEffect.name}</span></span></div>
                            <div class="progress-bar"><div class="fill" style="width:${f.armament?.points || 0}%"></div></div>
                        </div>
                    </div>
                    <div style="margin-top:15px">
                        <button class="btn btn-primary" onclick="showRecruitModal()">æ‹›å‹Ÿå£«å…µ</button>
                        <button class="btn btn-success" onclick="showCreateArmyModal()">å»ºç«‹å†›å›¢</button>
                        <button class="btn btn-warning" onclick="showBuyEquipModal()">è´­ä¹°è£…å¤‡</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">ğŸ‘¤ ä¸Šçº§æ­¦å£«</div>
            <div class="card-body">
                <div class="table-wrapper"><div class="table-scroll" style="max-height:200px">
                    <table>
                        <thead><tr><th style="width:25%">å§“å</th><th style="width:15%">ç±»å‹</th><th style="width:15%">æ­¦åŠŸ</th><th style="width:15%">æ–‡æ²»</th><th style="width:30%">çŠ¶æ€</th></tr></thead>
                        <tbody>${f.samurai.map(s => {
                            const inArmy = armies.find(a => a.general === s.name);
                            return `<tr><td>${s.name}</td><td>${s.type}</td><td>${s.martial}</td><td>${s.civil}</td><td>${inArmy ? 'æŒ‡æŒ¥' + inArmy.name : 'é—²ç½®'}</td></tr>`;
                        }).join('')}</tbody>
                    </table>
                </div></div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">ğŸ¯ é¢†åœ°åˆ—è¡¨</div>
            <div class="card-body">
                <div class="table-wrapper"><div class="table-scroll">
                    <table>
                        <thead><tr><th style="width:8%">ä»£ç </th><th style="width:10%">ä»¤åˆ¶å›½</th><th style="width:10%">éƒ¡å</th><th style="width:10%">åŸæ± </th><th style="width:5%">ç­‰çº§</th><th style="width:10%">åŸºç¡€çŸ³é«˜</th><th style="width:10%">ç‰¹äº§1</th><th style="width:10%">ç‰¹äº§2</th><th style="width:10%">ç‰¹äº§3</th><th style="width:10%">é©»å†›</th></tr></thead>
                        <tbody>${territories.map(t => `<tr>
                            <td>${t.code}</td><td>${t.province}</td><td>${t.name}</td><td>${t.castle || '-'}</td><td>${t.castleLevel || '-'}</td>
                            <td>${(t.baseKoku || 0).toLocaleString()}</td>
                            <td>${t.product1 || '-'}</td><td>${t.product2 || '-'}</td><td>${t.product3 || '-'}</td>
                            <td>${t.garrison || '-'}</td>
                        </tr>`).join('')}</tbody>
                    </table>
                </div></div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">ğŸŒ å†›å›¢ç¼–åˆ¶</div>
            <div class="card-body">
                <div class="table-wrapper"><div class="table-scroll">
                    <table>
                        <thead><tr><th style="width:15%">å†›å›¢åç§°</th><th style="width:12%">å°†é¢†</th><th style="width:10%">äººæ•°</th><th style="width:8%">é“ç‚®</th><th style="width:8%">æˆ˜é©¬</th><th style="width:8%">å¤§ç­’</th><th style="width:15%">ä½ç½®</th><th style="width:24%">æ“ä½œ</th></tr></thead>
                        <tbody>${armies.map(a => `<tr>
                            <td>${a.name}</td><td>${a.general}</td><td>${a.soldiers}</td><td>${a.guns}</td><td>${a.horses}</td><td>${a.cannons}</td><td>${a.location}</td>
                            <td><button class="btn btn-primary" onclick="showArmyMenu(${a.id})">ç®¡ç†</button></td>
                        </tr>`).join('')}</tbody>
                    </table>
                </div></div>
            </div>
        </div>
        <div class="grid-2">
            <div class="card">
                <div class="card-header">ğŸ¤ å¤–äº¤å…³ç³»</div>
                <div class="card-body">
                    <div class="table-wrapper"><div class="table-scroll" style="max-height:200px">
                        <table>
                            <thead><tr><th style="width:50%">ç›®æ ‡åŠ¿åŠ›</th><th style="width:50%">å…³ç³»</th></tr></thead>
                            <tbody>${(f.diplomacy || []).map(d => `<tr><td>${d.target}</td><td style="color:${d.relation === 'åŒç›Ÿ' ? 'green' : d.relation === 'æ•Œå¯¹' ? 'red' : 'orange'}">${d.relation}</td></tr>`).join('')}</tbody>
                        </table>
                    </div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">ğŸ“Š æ”¯å‡ºæ˜ç»†</div>
                <div class="card-body">
                    <div class="info-item"><span class="label">å£«å…µç»´æŠ¤</span><span class="value">${eco.maintDetail.soldierMaint.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">æˆ˜é©¬ç»´æŠ¤</span><span class="value">${eco.maintDetail.horseMaint.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">é“ç‚®ç»´æŠ¤</span><span class="value">${eco.maintDetail.gunMaint.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">å¤§ç­’ç»´æŠ¤</span><span class="value">${eco.maintDetail.cannonMaint.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">å†›å›¢å‡ºå¾è´¹</span><span class="value">${eco.maintDetail.armyExtraMaint.toLocaleString()} çŸ³</span></div>
                    <div class="info-item"><span class="label">æ­¦å£«ä¿¸ç¦„</span><span class="value">${eco.maintDetail.samuraiMaint.toLocaleString()} çŸ³</span></div>
                </div>
            </div>
        </div>
    `;
}

// ==================== ç©å®¶æ“ä½œ ====================
function showRecruitModal() {
    const f = gameData.factions[currentFaction];
    const eco = calcFactionEconomy(currentFaction);
    const canRecruit = Math.max(0, eco.maxSoldiers - eco.totalSoldiers);
    
    openModal('æ‹›å‹Ÿå£«å…µ', `
        <p style="margin-bottom:15px">å½“å‰å£«å…µä¸Šé™ï¼š${eco.maxSoldiers}ï¼Œå·²æœ‰ï¼š${eco.totalSoldiers}ï¼Œå¯æ‹›å‹Ÿï¼š${canRecruit}</p>
        <div class="form-group">
            <label>æ‹›å‹Ÿæ•°é‡</label>
            <div class="slider-group">
                <input type="range" id="recruitSlider" min="0" max="${canRecruit}" value="0" oninput="document.getElementById('recruitInput').value=this.value">
                <input type="number" id="recruitInput" min="0" max="${canRecruit}" value="0" oninput="syncSlider('recruitSlider',this.value,0,${canRecruit})">
            </div>
        </div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ç¡®è®¤æ‹›å‹Ÿ', class: 'btn-success', action: 'confirmRecruit()' }
    ]);
}

function confirmRecruit() {
    const amount = parseInt(document.getElementById('recruitInput').value) || 0;
    if (amount <= 0) { alert('è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡'); return; }
    const f = gameData.factions[currentFaction];
    f.soldiers.idle = (f.soldiers.idle || 0) + amount;
    addOperationLog(f.name, `æ‹›å‹Ÿäº† ${amount} åå£«å…µ`);
    closeModal();
    renderPlayerView();
}

function showCreateArmyModal() {
    const f = gameData.factions[currentFaction];
    const territories = gameData.territories.filter(t => t.owner === currentFaction);
    const busyGenerals = gameData.armies.filter(a => a.faction === currentFaction).map(a => a.general);
    
    openModal('å»ºç«‹å†›å›¢', `
        <div class="form-group" id="fg-name">
            <label>å†›å›¢åç§°ï¼ˆ1-8ä¸ªä¸­æ–‡å­—ç¬¦ï¼‰</label>
            <input type="text" id="newArmyName" maxlength="8">
            <div class="error-msg">è¯·è¾“å…¥1-8ä¸ªä¸­æ–‡å­—ç¬¦</div>
        </div>
        <div class="form-group" id="fg-general">
            <label>é€‰æ‹©å°†é¢†</label>
            <select id="newArmyGeneral">
                <option value="">-- è¯·é€‰æ‹© --</option>
                ${f.samurai.map(s => `<option value="${s.name}" ${busyGenerals.includes(s.name) ? 'data-busy="1"' : ''}>${s.name}${busyGenerals.includes(s.name) ? ' [å·²ä»»èŒ]' : ''}</option>`).join('')}
            </select>
            <div class="error-msg">è¯·é€‰æ‹©å°†é¢†</div>
        </div>
        <div class="form-group">
            <label>å†›å›¢äººæ•°ï¼ˆé—²ç½®ï¼š${f.soldiers.idle || 0}ï¼‰</label>
            <div class="slider-group">
                <input type="range" id="newArmySoldiers" min="1" max="${f.soldiers.idle || 1}" value="1" oninput="document.getElementById('newArmySoldiersInput').value=this.value">
                <input type="number" id="newArmySoldiersInput" min="1" max="${f.soldiers.idle || 1}" value="1" oninput="syncSlider('newArmySoldiers',this.value,1,${f.soldiers.idle || 1})">
            </div>
        </div>
        <div class="form-group">
            <label>é“ç‚®ï¼ˆåº“å­˜ï¼š${f.arsenal.guns}ï¼‰</label>
            <div class="slider-group">
                <input type="range" id="newArmyGuns" min="0" max="${f.arsenal.guns}" value="0" oninput="document.getElementById('newArmyGunsInput').value=this.value">
                <input type="number" id="newArmyGunsInput" min="0" max="${f.arsenal.guns}" value="0" oninput="syncSlider('newArmyGuns',this.value,0,${f.arsenal.guns})">
            </div>
        </div>
        <div class="form-group">
            <label>æˆ˜é©¬ï¼ˆåº“å­˜ï¼š${f.arsenal.horses}ï¼‰</label>
            <div class="slider-group">
                <input type="range" id="newArmyHorses" min="0" max="${f.arsenal.horses}" value="0" oninput="document.getElementById('newArmyHorsesInput').value=this.value">
                <input type="number" id="newArmyHorsesInput" min="0" max="${f.arsenal.horses}" value="0" oninput="syncSlider('newArmyHorses',this.value,0,${f.arsenal.horses})">
            </div>
        </div>
        <div class="form-group">
            <label>å¤§ç­’ï¼ˆåº“å­˜ï¼š${f.arsenal.cannons}ï¼‰</label>
            <div class="slider-group">
                <input type="range" id="newArmyCannons" min="0" max="${f.arsenal.cannons}" value="0" oninput="document.getElementById('newArmyCannonsInput').value=this.value">
                <input type="number" id="newArmyCannonsInput" min="0" max="${f.arsenal.cannons}" value="0" oninput="syncSlider('newArmyCannons',this.value,0,${f.arsenal.cannons})">
            </div>
        </div>
        <div class="form-group" id="fg-location">
            <label>åˆ›å»ºä½ç½®</label>
            <select id="newArmyLocation">
                <option value="">-- è¯·é€‰æ‹© --</option>
                ${territories.map(t => `<option value="${t.name}">${t.name}ï¼ˆ${t.castle || 'æ— åŸ'}ï¼‰</option>`).join('')}
            </select>
            <div class="error-msg">è¯·é€‰æ‹©ä½ç½®</div>
        </div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'æ¸…ç©º', class: 'btn-warning', action: 'clearCreateArmyForm()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: 'validateAndCreateArmy()' }
    ]);
}

function clearCreateArmyForm() {
    document.getElementById('newArmyName').value = '';
    document.getElementById('newArmyGeneral').value = '';
    document.getElementById('newArmySoldiers').value = 1;
    document.getElementById('newArmySoldiersInput').value = 1;
    document.getElementById('newArmyGuns').value = 0;
    document.getElementById('newArmyGunsInput').value = 0;
    document.getElementById('newArmyHorses').value = 0;
    document.getElementById('newArmyHorsesInput').value = 0;
    document.getElementById('newArmyCannons').value = 0;
    document.getElementById('newArmyCannonsInput').value = 0;
    document.getElementById('newArmyLocation').value = '';
    ['fg-name', 'fg-general', 'fg-location'].forEach(id => document.getElementById(id).classList.remove('error'));
}

function validateAndCreateArmy() {
    let valid = true;
    const name = document.getElementById('newArmyName').value.trim();
    if (!/^[\u4e00-\u9fa5]{1,8}$/.test(name)) {
        document.getElementById('fg-name').classList.add('error');
        valid = false;
    } else {
        document.getElementById('fg-name').classList.remove('error');
    }
    
    const general = document.getElementById('newArmyGeneral').value;
    if (!general) {
        document.getElementById('fg-general').classList.add('error');
        valid = false;
    } else {
        document.getElementById('fg-general').classList.remove('error');
    }
    
    const location = document.getElementById('newArmyLocation').value;
    if (!location) {
        document.getElementById('fg-location').classList.add('error');
        valid = false;
    } else {
        document.getElementById('fg-location').classList.remove('error');
    }
    
    if (!valid) return;
    
    const existingArmy = gameData.armies.find(a => a.faction === currentFaction && a.general === general);
    const data = {
        name,
        general,
        soldiers: parseInt(document.getElementById('newArmySoldiersInput').value) || 1,
        guns: parseInt(document.getElementById('newArmyGunsInput').value) || 0,
        horses: parseInt(document.getElementById('newArmyHorsesInput').value) || 0,
        cannons: parseInt(document.getElementById('newArmyCannonsInput').value) || 0,
        location
    };
    
    if (existingArmy) {
        showGeneralConflict(general, existingArmy, data);
    } else {
        createArmy(data);
    }
}

function showGeneralConflict(general, oldArmy, newData) {
    openModal('å°†é¢†å†²çª', `<p>æ˜¯å¦å°†ã€${general}ã€‘ä»ã€${oldArmy.name}ã€‘è°ƒä»»ä¸ºã€${newData.name}ã€‘å°†é¢†ï¼Ÿ</p>`, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'showCreateArmyModal()' },
        { text: 'ç¡®è®¤', class: 'btn-success', action: `handleGeneralConflict('${general}',${oldArmy.id},${JSON.stringify(newData).replace(/"/g, '&quot;')})` }
    ]);
}

function handleGeneralConflict(general, oldArmyId, newData) {
    createArmy(newData);
    const f = gameData.factions[currentFaction];
    const oldArmy = gameData.armies.find(a => a.id === oldArmyId);
    const busyGenerals = gameData.armies.filter(a => a.faction === currentFaction && a.id !== oldArmyId).map(a => a.general);
    const idleSamurai = f.samurai.filter(s => !busyGenerals.includes(s.name) && s.name !== general);
    
    openModal('å¤„ç†åŸå†›å›¢', `
        <p>ã€${oldArmy.name}ã€‘å¤±å»æŒ‡æŒ¥å®˜ï¼Œè¯·é€‰æ‹©æ“ä½œï¼š</p>
        ${idleSamurai.length > 0 ? `<div class="form-group"><label>æŒ‡æ´¾æ–°å°†é¢†</label><select id="newGeneralForOld"><option value="">-- é€‰æ‹© --</option>${idleSamurai.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}</select></div>` : '<p style="color:#999">æ²¡æœ‰å¯ç”¨æ­¦å£«</p>'}
    `, [
        { text: 'è§£æ•£åŸå†›å›¢', class: 'btn-danger', action: `disbandArmy(${oldArmyId})` },
        ...(idleSamurai.length > 0 ? [{ text: 'æŒ‡æ´¾æ–°å°†é¢†', class: 'btn-success', action: `assignNewGeneral(${oldArmyId})` }] : [])
    ]);
}

function assignNewGeneral(armyId) {
    const newGeneral = document.getElementById('newGeneralForOld').value;
    if (!newGeneral) { alert('è¯·é€‰æ‹©æ–°å°†é¢†'); return; }
    const army = gameData.armies.find(a => a.id === armyId);
    army.general = newGeneral;
    addOperationLog(currentUser, `å°†ã€${newGeneral}ã€‘æŒ‡æ´¾ä¸ºã€${army.name}ã€‘å°†é¢†`);
    closeModal();
    renderPlayerView();
}

function createArmy(data) {
    const f = gameData.factions[currentFaction];
    const newArmy = {
        id: gameData.nextArmyId++,
        faction: currentFaction,
        name: data.name,
        general: data.general,
        soldiers: data.soldiers,
        guns: data.guns,
        horses: data.horses,
        cannons: data.cannons,
        location: data.location
    };
    
    f.soldiers.idle -= data.soldiers;
    f.arsenal.guns -= data.guns;
    f.arsenal.horses -= data.horses;
    f.arsenal.cannons -= data.cannons;
    
    const territory = gameData.territories.find(t => t.name === data.location);
    if (territory) territory.garrison = data.name;
    
    gameData.armies.push(newArmy);
    addOperationLog(f.name, `å»ºç«‹å†›å›¢ã€${data.name}ã€‘`);
    closeModal();
    renderPlayerView();
}

function showArmyMenu(armyId) {
    const army = gameData.armies.find(a => a.id === armyId);
    if (!army) return;
    openModal('ç®¡ç†å†›å›¢ï¼š' + army.name, `
        <div class="info-item"><span class="label">å°†é¢†</span><span class="value">${army.general}</span></div>
        <div class="info-item"><span class="label">äººæ•°</span><span class="value">${army.soldiers}</span></div>
        <div class="info-item"><span class="label">é“ç‚®</span><span class="value">${army.guns}</span></div>
        <div class="info-item"><span class="label">æˆ˜é©¬</span><span class="value">${army.horses}</span></div>
        <div class="info-item"><span class="label">å¤§ç­’</span><span class="value">${army.cannons}</span></div>
        <div class="info-item"><span class="label">ä½ç½®</span><span class="value">${army.location}</span></div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ç¼–è¾‘äººæ•°', class: 'btn-primary', action: `showEditSoldiers(${armyId})` },
        { text: 'ç¼–è¾‘è£…å¤‡', class: 'btn-primary', action: `showEditEquip(${armyId})` },
        { text: 'è§£æ•£å†›å›¢', class: 'btn-danger', action: `confirmDisband(${armyId})` }
    ]);
}

function showEditSoldiers(armyId) {
    const army = gameData.armies.find(a => a.id === armyId);
    const f = gameData.factions[currentFaction];
    const max = army.soldiers + (f.soldiers.idle || 0);
    openModal('ç¼–è¾‘äººæ•°', `
        <div class="form-group">
            <label>å†›å›¢äººæ•°ï¼ˆå½“å‰ï¼š${army.soldiers}ï¼Œé—²ç½®ï¼š${f.soldiers.idle || 0}ï¼‰</label>
            <div class="slider-group">
                <input type="range" id="editSoldiers" min="0" max="${max}" value="${army.soldiers}" oninput="document.getElementById('editSoldiersInput').value=this.value">
                <input type="number" id="editSoldiersInput" min="0" max="${max}" value="${army.soldiers}" oninput="syncSlider('editSoldiers',this.value,0,${max})">
            </div>
        </div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: `saveEditSoldiers(${armyId})` }
    ]);
}

function saveEditSoldiers(armyId) {
    const army = gameData.armies.find(a => a.id === armyId);
    const f = gameData.factions[currentFaction];
    const newVal = parseInt(document.getElementById('editSoldiersInput').value) || 0;
    if (newVal === 0) { if (confirm('äººæ•°ä¸º0å°†è§£æ•£å†›å›¢ï¼Œç¡®å®šï¼Ÿ')) disbandArmy(armyId); return; }
    const diff = newVal - army.soldiers;
    f.soldiers.idle -= diff;
    army.soldiers = newVal;
    addOperationLog(f.name, `è°ƒæ•´ã€${army.name}ã€‘äººæ•°ä¸º${newVal}`);
    closeModal();
    renderPlayerView();
}

function showEditEquip(armyId) {
    const army = gameData.armies.find(a => a.id === armyId);
    const f = gameData.factions[currentFaction];
    const maxG = army.guns + f.arsenal.guns;
    const maxH = army.horses + f.arsenal.horses;
    const maxC = army.cannons + f.arsenal.cannons;
    openModal('ç¼–è¾‘è£…å¤‡', `
        <div class="form-group"><label>é“ç‚®ï¼ˆå½“å‰ï¼š${army.guns}ï¼Œåº“å­˜ï¼š${f.arsenal.guns}ï¼‰</label>
            <div class="slider-group"><input type="range" id="editGuns" min="0" max="${maxG}" value="${army.guns}" oninput="document.getElementById('editGunsInput').value=this.value"><input type="number" id="editGunsInput" min="0" max="${maxG}" value="${army.guns}" oninput="syncSlider('editGuns',this.value,0,${maxG})"></div></div>
        <div class="form-group"><label>æˆ˜é©¬ï¼ˆå½“å‰ï¼š${army.horses}ï¼Œåº“å­˜ï¼š${f.arsenal.horses}ï¼‰</label>
            <div class="slider-group"><input type="range" id="editHorses" min="0" max="${maxH}" value="${army.horses}" oninput="document.getElementById('editHorsesInput').value=this.value"><input type="number" id="editHorsesInput" min="0" max="${maxH}" value="${army.horses}" oninput="syncSlider('editHorses',this.value,0,${maxH})"></div></div>
        <div class="form-group"><label>å¤§ç­’ï¼ˆå½“å‰ï¼š${army.cannons}ï¼Œåº“å­˜ï¼š${f.arsenal.cannons}ï¼‰</label>
            <div class="slider-group"><input type="range" id="editCannons" min="0" max="${maxC}" value="${army.cannons}" oninput="document.getElementById('editCannonsInput').value=this.value"><input type="number" id="editCannonsInput" min="0" max="${maxC}" value="${army.cannons}" oninput="syncSlider('editCannons',this.value,0,${maxC})"></div></div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: `saveEditEquip(${armyId})` }
    ]);
}

function saveEditEquip(armyId) {
    const army = gameData.armies.find(a => a.id === armyId);
    const f = gameData.factions[currentFaction];
    const newG = parseInt(document.getElementById('editGunsInput').value) || 0;
    const newH = parseInt(document.getElementById('editHorsesInput').value) || 0;
    const newC = parseInt(document.getElementById('editCannonsInput').value) || 0;
    f.arsenal.guns -= (newG - army.guns);
    f.arsenal.horses -= (newH - army.horses);
    f.arsenal.cannons -= (newC - army.cannons);
    army.guns = newG;
    army.horses = newH;
    army.cannons = newC;
    addOperationLog(f.name, `è°ƒæ•´ã€${army.name}ã€‘è£…å¤‡`);
    closeModal();
    renderPlayerView();
}

function confirmDisband(armyId) {
    const army = gameData.armies.find(a => a.id === armyId);
    openModal('ç¡®è®¤è§£æ•£', `<p>ç¡®å®šè§£æ•£ã€${army.name}ã€‘ï¼Ÿèµ„æºå°†è¿”è¿˜åº“å­˜ã€‚</p>`, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ç¡®è®¤', class: 'btn-danger', action: `disbandArmy(${armyId})` }
    ]);
}

function disbandArmy(armyId) {
    const army = gameData.armies.find(a => a.id === armyId);
    if (!army) return;
    const f = gameData.factions[army.faction];
    f.soldiers.idle = (f.soldiers.idle || 0) + army.soldiers;
    f.arsenal.guns += army.guns;
    f.arsenal.horses += army.horses;
    f.arsenal.cannons += army.cannons;
    const territory = gameData.territories.find(t => t.garrison === army.name);
    if (territory) territory.garrison = '';
    gameData.armies = gameData.armies.filter(a => a.id !== armyId);
    addOperationLog(f.name, `è§£æ•£å†›å›¢ã€${army.name}ã€‘`);
    closeModal();
    if (isAdmin) renderAdminArmies();
    else renderPlayerView();
}

function showBuyEquipModal() {
    const f = gameData.factions[currentFaction];
    openModal('è´­ä¹°è£…å¤‡', `
        <p style="margin-bottom:15px">å½“å‰èµ„é‡‘ï¼š${(f.money || 0).toLocaleString()} çŸ³</p>
        <p style="margin-bottom:15px;font-size:12px;color:#666">ä»·æ ¼ï¼šé“ç‚®10çŸ³/æŒºï¼Œæˆ˜é©¬12çŸ³/åŒ¹ï¼Œå¤§ç­’450çŸ³/é—¨</p>
        <div class="form-group"><label>è´­ä¹°é“ç‚®</label><input type="number" id="buyGuns" min="0" value="0"></div>
        <div class="form-group"><label>è´­ä¹°æˆ˜é©¬</label><input type="number" id="buyHorses" min="0" value="0"></div>
        <div class="form-group"><label>è´­ä¹°å¤§ç­’</label><input type="number" id="buyCannons" min="0" value="0"></div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'è´­ä¹°', class: 'btn-success', action: 'confirmBuyEquip()' }
    ]);
}

function confirmBuyEquip() {
    const f = gameData.factions[currentFaction];
    const guns = parseInt(document.getElementById('buyGuns').value) || 0;
    const horses = parseInt(document.getElementById('buyHorses').value) || 0;
    const cannons = parseInt(document.getElementById('buyCannons').value) || 0;
    const cost = guns * 10 + horses * 12 + cannons * 450;
    if (cost > (f.money || 0)) { alert('èµ„é‡‘ä¸è¶³'); return; }
    if (cost === 0) { alert('è¯·è¾“å…¥è´­ä¹°æ•°é‡'); return; }
    f.money -= cost;
    f.arsenal.guns += guns;
    f.arsenal.horses += horses;
    f.arsenal.cannons += cannons;
    addOperationLog(f.name, `è´­ä¹°è£…å¤‡ï¼šé“ç‚®${guns}ï¼Œæˆ˜é©¬${horses}ï¼Œå¤§ç­’${cannons}ï¼ŒèŠ±è´¹${cost}çŸ³`);
    closeModal();
    renderPlayerView();
}

// ==================== ç®¡ç†å‘˜è§†å›¾ ====================
function renderAdminView() {
    renderAdminTerritories();
    renderAdminFactions();
    renderAdminProducts();
    renderAdminArmies();
    renderAdminChronicle();
    renderAdminInvestment();
    renderAdminImport();
    renderAdminLogs();
    renderAdminBackup();
}

function switchAdminTab(tabName) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('panel-' + tabName).classList.add('active');
}

// éƒ¡å›½æ•°æ®ç®¡ç†
function renderAdminTerritories() {
    const panel = document.getElementById('panel-territories');
    panel.innerHTML = `
        <div class="toolbar">
            <button class="btn btn-success" onclick="showAddTerritoryModal()">æ–°å¢é¢†åœ°</button>
            <input type="text" id="territorySearch" placeholder="æœç´¢..." oninput="filterTerritories()" style="width:150px">
        </div>
        <div class="table-wrapper"><div class="table-scroll" style="max-height:550px">
            <table>
                <thead><tr>
                    <th style="width:6%">ä»£ç </th>
                    <th style="width:7%">ä»¤åˆ¶å›½</th>
                    <th style="width:7%">éƒ¡å</th>
                    <th style="width:7%">åŸæ± </th>
                    <th style="width:4%">ç­‰çº§</th>
                    <th style="width:7%">åŸºç¡€çŸ³é«˜</th>
                    <th style="width:6%">ç‰¹äº§1</th>
                    <th style="width:6%">ç‰¹äº§2</th>
                    <th style="width:6%">ç‰¹äº§3</th>
                    <th style="width:7%">å¯å‘å±•ç‰¹äº§</th>
                    <th style="width:7%">æ‰€å±åŠ¿åŠ›</th>
                    <th style="width:7%">é©»å†›</th>
                    <th style="width:10%">ç®€ä»‹</th>
                    <th style="width:13%">æ“ä½œ</th>
                </tr></thead>
                <tbody id="territoriesList"></tbody>
            </table>
        </div></div>
    `;
    updateTerritoriesList();
}

function updateTerritoriesList() {
    const search = (document.getElementById('territorySearch')?.value || '').toLowerCase();
    const filtered = gameData.territories.filter(t => 
        t.name.toLowerCase().includes(search) || t.province.toLowerCase().includes(search) || t.code.toLowerCase().includes(search)
    );
    document.getElementById('territoriesList').innerHTML = filtered.map(t => {
        const owner = t.owner ? (gameData.factions[t.owner]?.name || '-') : '-';
        const desc = t.description || '';
        return `<tr>
            <td>${t.code}</td>
            <td>${t.province}</td>
            <td>${t.name}</td>
            <td>${t.castle || '-'}</td>
            <td>${t.castleLevel || '-'}</td>
            <td>${(t.baseKoku || 0).toLocaleString()}</td>
            <td>${t.product1 || '-'}</td>
            <td>${t.product2 || '-'}</td>
            <td>${t.product3 || '-'}</td>
            <td>${t.developableProduct || '-'}</td>
            <td>${owner}</td>
            <td>${t.garrison || '-'}</td>
            <td title="${desc}">${desc.length > 8 ? desc.substring(0, 8) + '...' : (desc || '-')}</td>
            <td>
                <button class="btn btn-primary" onclick="showEditTerritoryModal('${t.code}')">ç¼–è¾‘</button>
                <button class="btn btn-danger" onclick="deleteTerritory('${t.code}')">åˆ é™¤</button>
            </td>
        </tr>`;
    }).join('');
}

function filterTerritories() { updateTerritoriesList(); }

function showAddTerritoryModal() {
    openModal('æ–°å¢é¢†åœ°', `
        <div class="grid-2">
            <div class="form-group"><label>éƒ¡å›½ä»£ç </label><input type="text" id="newTCode" placeholder="å¦‚RUXI01"></div>
            <div class="form-group"><label>ä»¤åˆ¶å›½</label><input type="text" id="newTProvince" placeholder="å¦‚è‹¥ç‹­å›½"></div>
            <div class="form-group"><label>éƒ¡å</label><input type="text" id="newTName"></div>
            <div class="form-group"><label>åŸæ± åç§°</label><input type="text" id="newTCastle"></div>
            <div class="form-group"><label>åŸæ± ç­‰çº§(1-7)</label><input type="number" id="newTCastleLevel" min="0" max="7" value="0"></div>
            <div class="form-group"><label>åŸºç¡€çŸ³é«˜</label><input type="number" id="newTKoku" value="10000"></div>
            <div class="form-group"><label>ç‰¹äº§1</label><select id="newTP1"><option value="">æ— </option>${Object.keys(gameData.products).map(p => `<option value="${p}">${p}</option>`).join('')}</select></div>
            <div class="form-group"><label>ç‰¹äº§2</label><select id="newTP2"><option value="">æ— </option>${Object.keys(gameData.products).map(p => `<option value="${p}">${p}</option>`).join('')}</select></div>
            <div class="form-group"><label>ç‰¹äº§3</label><select id="newTP3"><option value="">æ— </option>${Object.keys(gameData.products).map(p => `<option value="${p}">${p}</option>`).join('')}</select></div>
            <div class="form-group"><label>å¯å‘å±•ç‰¹äº§</label><select id="newTDevP"><option value="">æ— </option>${Object.keys(gameData.products).map(p => `<option value="${p}">${p}</option>`).join('')}</select></div>
            <div class="form-group"><label>æ‰€å±åŠ¿åŠ›</label><select id="newTOwner"><option value="">æ— ä¸»</option>${Object.values(gameData.factions).map(f => `<option value="${f.id}">${f.name}</option>`).join('')}</select></div>
            <div class="form-group"><label>é©»æ‰å†›å›¢</label><input type="text" id="newTGarrison"></div>
        </div>
        <div class="form-group"><label>ç®€ä»‹</label><textarea id="newTDesc" rows="2"></textarea></div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: 'saveNewTerritory()' }
    ]);
}

function saveNewTerritory() {
    const code = document.getElementById('newTCode').value.trim();
    const name = document.getElementById('newTName').value.trim();
    if (!code || !name) { alert('è¯·å¡«å†™ä»£ç å’Œéƒ¡å'); return; }
    if (gameData.territories.find(t => t.code === code)) { alert('ä»£ç å·²å­˜åœ¨'); return; }
    gameData.territories.push({
        code,
        province: document.getElementById('newTProvince').value.trim(),
        name,
        castle: document.getElementById('newTCastle').value.trim(),
        castleLevel: parseInt(document.getElementById('newTCastleLevel').value) || 0,
        baseKoku: parseInt(document.getElementById('newTKoku').value) || 0,
        product1: document.getElementById('newTP1').value,
        product2: document.getElementById('newTP2').value,
        product3: document.getElementById('newTP3').value,
        developableProduct: document.getElementById('newTDevP').value,
        owner: document.getElementById('newTOwner').value,
        garrison: document.getElementById('newTGarrison').value.trim(),
        description: document.getElementById('newTDesc').value.trim()
    });
    addOperationLog('ç®¡ç†å‘˜', `æ–°å¢é¢†åœ°ã€${name}ã€‘`);
    closeModal();
    updateTerritoriesList();
}

function showEditTerritoryModal(code) {
    const t = gameData.territories.find(ter => ter.code === code);
    if (!t) return;
    openModal('ç¼–è¾‘é¢†åœ°', `
        <div class="grid-2">
            <div class="form-group"><label>éƒ¡å›½ä»£ç </label><input type="text" id="editTCode" value="${t.code}" readonly style="background:#eee"></div>
            <div class="form-group"><label>ä»¤åˆ¶å›½</label><input type="text" id="editTProvince" value="${t.province || ''}"></div>
            <div class="form-group"><label>éƒ¡å</label><input type="text" id="editTName" value="${t.name}"></div>
            <div class="form-group"><label>åŸæ± åç§°</label><input type="text" id="editTCastle" value="${t.castle || ''}"></div>
            <div class="form-group"><label>åŸæ± ç­‰çº§(1-7)</label><input type="number" id="editTCastleLevel" min="0" max="7" value="${t.castleLevel || 0}"></div>
            <div class="form-group"><label>åŸºç¡€çŸ³é«˜</label><input type="number" id="editTKoku" value="${t.baseKoku || 0}"></div>
            <div class="form-group"><label>ç‰¹äº§1</label><select id="editTP1"><option value="">æ— </option>${Object.keys(gameData.products).map(p => `<option value="${p}" ${t.product1 === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
            <div class="form-group"><label>ç‰¹äº§2</label><select id="editTP2"><option value="">æ— </option>${Object.keys(gameData.products).map(p => `<option value="${p}" ${t.product2 === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
            <div class="form-group"><label>ç‰¹äº§3</label><select id="editTP3"><option value="">æ— </option>${Object.keys(gameData.products).map(p => `<option value="${p}" ${t.product3 === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
            <div class="form-group"><label>å¯å‘å±•ç‰¹äº§</label><select id="editTDevP"><option value="">æ— </option>${Object.keys(gameData.products).map(p => `<option value="${p}" ${t.developableProduct === p ? 'selected' : ''}>${p}</option>`).join('')}</select></div>
            <div class="form-group"><label>æ‰€å±åŠ¿åŠ›</label><select id="editTOwner"><option value="">æ— ä¸»</option>${Object.values(gameData.factions).map(f => `<option value="${f.id}" ${t.owner === f.id ? 'selected' : ''}>${f.name}</option>`).join('')}</select></div>
            <div class="form-group"><label>é©»æ‰å†›å›¢</label><input type="text" id="editTGarrison" value="${t.garrison || ''}"></div>
        </div>
        <div class="form-group"><label>ç®€ä»‹</label><textarea id="editTDesc" rows="2">${t.description || ''}</textarea></div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: `saveEditTerritory('${code}')` }
    ]);
}

function saveEditTerritory(code) {
    const t = gameData.territories.find(ter => ter.code === code);
    if (!t) return;
    t.province = document.getElementById('editTProvince').value.trim();
    t.name = document.getElementById('editTName').value.trim();
    t.castle = document.getElementById('editTCastle').value.trim();
    t.castleLevel = parseInt(document.getElementById('editTCastleLevel').value) || 0;
    t.baseKoku = parseInt(document.getElementById('editTKoku').value) || 0;
    t.product1 = document.getElementById('editTP1').value;
    t.product2 = document.getElementById('editTP2').value;
    t.product3 = document.getElementById('editTP3').value;
    t.developableProduct = document.getElementById('editTDevP').value;
    t.owner = document.getElementById('editTOwner').value;
    t.garrison = document.getElementById('editTGarrison').value.trim();
    t.description = document.getElementById('editTDesc').value.trim();
    addOperationLog('ç®¡ç†å‘˜', `ç¼–è¾‘é¢†åœ°ã€${t.name}ã€‘`);
    closeModal();
    updateTerritoriesList();
}

function deleteTerritory(code) {
    if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    const idx = gameData.territories.findIndex(t => t.code === code);
    if (idx > -1) {
        const name = gameData.territories[idx].name;
        gameData.territories.splice(idx, 1);
        addOperationLog('ç®¡ç†å‘˜', `åˆ é™¤é¢†åœ°ã€${name}ã€‘`);
        updateTerritoriesList();
    }
}

// ç‰¹äº§å¯¹ç…§è¡¨
function renderAdminProducts() {
    const panel = document.getElementById('panel-products');
    panel.innerHTML = `
        <div class="toolbar">
            <button class="btn btn-success" onclick="showAddProductModal()">æ–°å¢ç‰¹äº§</button>
        </div>
        <div class="table-wrapper"><div class="table-scroll" style="max-height:500px">
            <table>
                <thead><tr>
                    <th style="width:15%">ç‰¹äº§åç§°</th>
                    <th style="width:12%">æ¯å¹´çŸ³é«˜</th>
                    <th style="width:12%">æ¯å¹´æˆ˜é©¬</th>
                    <th style="width:12%">å£«å…µä¸Šé™</th>
                    <th style="width:12%">çŸ³é«˜åŠ æˆ%</th>
                    <th style="width:22%">å…¶ä»–æ•ˆæœ</th>
                    <th style="width:15%">æ“ä½œ</th>
                </tr></thead>
                <tbody id="productsList"></tbody>
            </table>
        </div></div>
    `;
    updateProductsList();
}

function updateProductsList() {
    document.getElementById('productsList').innerHTML = Object.values(gameData.products).map(p => `<tr>
        <td>${p.name}</td>
        <td>${p.koku}</td>
        <td>${p.horses}</td>
        <td>${p.soldiers}</td>
        <td>${p.kokuBonus}%</td>
        <td>${p.effect || '-'}</td>
        <td>
            <button class="btn btn-primary" onclick="showEditProductModal('${p.name}')">ç¼–è¾‘</button>
            <button class="btn btn-danger" onclick="deleteProduct('${p.name}')">åˆ é™¤</button>
        </td>
    </tr>`).join('');
}

function showAddProductModal() {
    openModal('æ–°å¢ç‰¹äº§', `
        <div class="form-group"><label>ç‰¹äº§åç§°</label><input type="text" id="newProdName"></div>
        <div class="grid-2">
            <div class="form-group"><label>æ¯å¹´çŸ³é«˜</label><input type="number" id="newProdKoku" value="0"></div>
            <div class="form-group"><label>æ¯å¹´æˆ˜é©¬</label><input type="number" id="newProdHorses" value="0"></div>
            <div class="form-group"><label>å£«å…µä¸Šé™å¢åŠ </label><input type="number" id="newProdSoldiers" value="0"></div>
            <div class="form-group"><label>çŸ³é«˜åŠ æˆ(%)</label><input type="number" id="newProdBonus" value="0"></div>
        </div>
        <div class="form-group"><label>å…¶ä»–æ•ˆæœ</label><input type="text" id="newProdEffect"></div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: 'saveNewProduct()' }
    ]);
}

function saveNewProduct() {
    const name = document.getElementById('newProdName').value.trim();
    if (!name) { alert('è¯·è¾“å…¥åç§°'); return; }
    if (gameData.products[name]) { alert('è¯¥ç‰¹äº§å·²å­˜åœ¨'); return; }
    gameData.products[name] = {
        name,
        koku: parseInt(document.getElementById('newProdKoku').value) || 0,
        horses: parseInt(document.getElementById('newProdHorses').value) || 0,
        soldiers: parseInt(document.getElementById('newProdSoldiers').value) || 0,
        kokuBonus: parseInt(document.getElementById('newProdBonus').value) || 0,
        effect: document.getElementById('newProdEffect').value.trim()
    };
    addOperationLog('ç®¡ç†å‘˜', `æ–°å¢ç‰¹äº§ã€${name}ã€‘`);
    closeModal();
    updateProductsList();
}

function showEditProductModal(name) {
    const p = gameData.products[name];
    if (!p) return;
    openModal('ç¼–è¾‘ç‰¹äº§', `
        <div class="form-group"><label>ç‰¹äº§åç§°</label><input type="text" value="${p.name}" readonly style="background:#eee"></div>
        <div class="grid-2">
            <div class="form-group"><label>æ¯å¹´çŸ³é«˜</label><input type="number" id="editProdKoku" value="${p.koku}"></div>
            <div class="form-group"><label>æ¯å¹´æˆ˜é©¬</label><input type="number" id="editProdHorses" value="${p.horses}"></div>
            <div class="form-group"><label>å£«å…µä¸Šé™å¢åŠ </label><input type="number" id="editProdSoldiers" value="${p.soldiers}"></div>
            <div class="form-group"><label>çŸ³é«˜åŠ æˆ(%)</label><input type="number" id="editProdBonus" value="${p.kokuBonus}"></div>
        </div>
        <div class="form-group"><label>å…¶ä»–æ•ˆæœ</label><input type="text" id="editProdEffect" value="${p.effect || ''}"></div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: `saveEditProduct('${name}')` }
    ]);
}

function saveEditProduct(name) {
    const p = gameData.products[name];
    if (!p) return;
    p.koku = parseInt(document.getElementById('editProdKoku').value) || 0;
    p.horses = parseInt(document.getElementById('editProdHorses').value) || 0;
    p.soldiers = parseInt(document.getElementById('editProdSoldiers').value) || 0;
    p.kokuBonus = parseInt(document.getElementById('editProdBonus').value) || 0;
    p.effect = document.getElementById('editProdEffect').value.trim();
    addOperationLog('ç®¡ç†å‘˜', `ç¼–è¾‘ç‰¹äº§ã€${name}ã€‘`);
    closeModal();
    updateProductsList();
}

function deleteProduct(name) {
    if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    delete gameData.products[name];
    addOperationLog('ç®¡ç†å‘˜', `åˆ é™¤ç‰¹äº§ã€${name}ã€‘`);
    updateProductsList();
}

// åŠ¿åŠ›ç®¡ç†
function renderAdminFactions() {
    const panel = document.getElementById('panel-factions');
    panel.innerHTML = `
        <div class="toolbar">
            <button class="btn btn-success" onclick="showAddFactionModal()">æ–°å¢åŠ¿åŠ›</button>
        </div>
        <div class="table-wrapper"><div class="table-scroll" style="max-height:500px">
            <table>
                <thead><tr>
                    <th style="width:8%">ID</th>
                    <th style="width:10%">åç§°</th>
                    <th style="width:10%">å®¶ä¸»</th>
                    <th style="width:8%">ä»£ç </th>
                    <th style="width:8%">ç¨ç‡</th>
                    <th style="width:10%">èµ„é‡‘</th>
                    <th style="width:8%">å†œä¸š</th>
                    <th style="width:8%">æ°´å†›</th>
                    <th style="width:8%">æ­¦å¤‡</th>
                    <th style="width:22%">æ“ä½œ</th>
                </tr></thead>
                <tbody id="factionsList"></tbody>
            </table>
        </div></div>
    `;
    updateFactionsList();
}

function updateFactionsList() {
    document.getElementById('factionsList').innerHTML = Object.values(gameData.factions).map(f => {
        const agri = getAgricultureEffect(f.agriculture?.points || 0);
        const navy = getNavyLevel(f.navy?.points || 0);
        const arma = getArmamentEffect(f.armament?.points || 0);
        return `<tr>
            <td>${f.id}</td>
            <td>${f.name}</td>
            <td>${f.lord}</td>
            <td><code>${f.code}</code></td>
            <td>${f.taxRate || 60}%</td>
            <td>${(f.money || 0).toLocaleString()}</td>
            <td><span class="level-badge level-${agri.level}">${agri.name}</span></td>
            <td><span class="level-badge level-${navy.level}">${navy.name}</span></td>
            <td><span class="level-badge level-${arma.level}">${arma.name}</span></td>
            <td>
                <button class="btn btn-primary" onclick="showEditFactionModal('${f.id}')">ç¼–è¾‘</button>
                <button class="btn btn-warning" onclick="showFactionDetailModal('${f.id}')">è¯¦ç»†</button>
                <button class="btn btn-danger" onclick="deleteFaction('${f.id}')">åˆ é™¤</button>
            </td>
        </tr>`;
    }).join('');
}

function showAddFactionModal() {
    openModal('æ–°å¢åŠ¿åŠ›', `
        <div class="grid-2">
            <div class="form-group"><label>åŠ¿åŠ›ID</label><input type="text" id="newFId"></div>
            <div class="form-group"><label>åŠ¿åŠ›åç§°</label><input type="text" id="newFName"></div>
            <div class="form-group"><label>å®¶ä¸»</label><input type="text" id="newFLord"></div>
            <div class="form-group"><label>ç™»å½•ä»£ç </label><input type="text" id="newFCode"></div>
            <div class="form-group"><label>ç¨ç‡(%)</label><input type="number" id="newFTax" value="60" min="40" max="80"></div>
            <div class="form-group"><label>äº§ä¸šçŸ³é«˜</label><input type="number" id="newFIndustry" value="10000"></div>
        </div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: 'saveNewFaction()' }
    ]);
}

function saveNewFaction() {
    const id = document.getElementById('newFId').value.trim();
    const name = document.getElementById('newFName').value.trim();
    const code = document.getElementById('newFCode').value.trim();
    if (!id || !name || !code) { alert('è¯·å¡«å†™å®Œæ•´'); return; }
    if (gameData.factions[id]) { alert('IDå·²å­˜åœ¨'); return; }
    gameData.factions[id] = {
        id, name, lord: document.getElementById('newFLord').value.trim(), code,
        taxRate: parseInt(document.getElementById('newFTax').value) || 60,
        industryKoku: parseInt(document.getElementById('newFIndustry').value) || 10000,
        agriculture: { points: 15 }, commerce: { points: 0 }, navy: { points: 10 }, armament: { points: 15 },
        arsenal: { guns: 0, horses: 0, cannons: 0 },
        soldiers: { idle: 0, total: 0 },
        money: 0, buffs: [], samurai: [], diplomacy: []
    };
    addOperationLog('ç®¡ç†å‘˜', `æ–°å¢åŠ¿åŠ›ã€${name}ã€‘`);
    closeModal();
    updateFactionsList();
}

function showEditFactionModal(fid) {
    const f = gameData.factions[fid];
    if (!f) return;
    openModal('ç¼–è¾‘åŠ¿åŠ›', `
        <div class="grid-2">
            <div class="form-group"><label>åŠ¿åŠ›ID</label><input type="text" value="${f.id}" readonly style="background:#eee"></div>
            <div class="form-group"><label>åŠ¿åŠ›åç§°</label><input type="text" id="editFName" value="${f.name}"></div>
            <div class="form-group"><label>å®¶ä¸»</label><input type="text" id="editFLord" value="${f.lord}"></div>
            <div class="form-group"><label>ç™»å½•ä»£ç </label><input type="text" id="editFCode" value="${f.code}"></div>
            <div class="form-group"><label>ç¨ç‡(%)</label><input type="number" id="editFTax" value="${f.taxRate || 60}" min="40" max="80"></div>
            <div class="form-group"><label>äº§ä¸šçŸ³é«˜</label><input type="number" id="editFIndustry" value="${f.industryKoku || 10000}"></div>
            <div class="form-group"><label>èµ„é‡‘</label><input type="number" id="editFMoney" value="${f.money || 0}"></div>
        </div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: `saveEditFaction('${fid}')` }
    ]);
}

function saveEditFaction(fid) {
    const f = gameData.factions[fid];
    if (!f) return;
    f.name = document.getElementById('editFName').value.trim();
    f.lord = document.getElementById('editFLord').value.trim();
    f.code = document.getElementById('editFCode').value.trim();
    f.taxRate = parseInt(document.getElementById('editFTax').value) || 60;
    f.industryKoku = parseInt(document.getElementById('editFIndustry').value) || 10000;
    f.money = parseInt(document.getElementById('editFMoney').value) || 0;
    addOperationLog('ç®¡ç†å‘˜', `ç¼–è¾‘åŠ¿åŠ›ã€${f.name}ã€‘`);
    closeModal();
    updateFactionsList();
}

function showFactionDetailModal(fid) {
    const f = gameData.factions[fid];
    if (!f) return;
    openModal('åŠ¿åŠ›è¯¦æƒ…ï¼š' + f.name, `
        <h4 style="margin-bottom:10px;color:var(--primary-color)">æ­¦åº“</h4>
        <div class="grid-3">
            <div class="form-group"><label>é“ç‚®</label><input type="number" id="detailGuns" value="${f.arsenal.guns}"></div>
            <div class="form-group"><label>æˆ˜é©¬</label><input type="number" id="detailHorses" value="${f.arsenal.horses}"></div>
            <div class="form-group"><label>å¤§ç­’</label><input type="number" id="detailCannons" value="${f.arsenal.cannons}"></div>
        </div>
        <h4 style="margin:15px 0 10px;color:var(--primary-color)">å£«å…µ</h4>
        <div class="form-group"><label>é—²ç½®å£«å…µ</label><input type="number" id="detailIdle" value="${f.soldiers.idle || 0}"></div>
        <h4 style="margin:15px 0 10px;color:var(--primary-color)">å‘å±•ç‚¹æ•°</h4>
        <div class="grid-3">
            <div class="form-group"><label>å†œä¸š(0-100)</label><input type="number" id="detailAgri" value="${f.agriculture?.points || 0}" min="0" max="100"></div>
            <div class="form-group"><label>æ°´å†›(0-100)</label><input type="number" id="detailNavy" value="${f.navy?.points || 0}" min="0" max="100"></div>
            <div class="form-group"><label>æ­¦å¤‡(0-100)</label><input type="number" id="detailArma" value="${f.armament?.points || 0}" min="0" max="100"></div>
        </div>
        <h4 style="margin:15px 0 10px;color:var(--primary-color)">ä¸Šçº§æ­¦å£«</h4>
        <div id="samuraiListDetail">${f.samurai.map((s, i) => `<div class="info-item"><span>${s.name}(${s.type}) æ­¦${s.martial}/æ–‡${s.civil}</span><button class="btn btn-danger" onclick="removeSamurai('${fid}',${i})">åˆ </button></div>`).join('')}</div>
        <button class="btn btn-success" onclick="showAddSamuraiModal('${fid}')" style="margin-top:10px">æ·»åŠ æ­¦å£«</button>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: `saveFactionDetail('${fid}')` }
    ]);
}

function saveFactionDetail(fid) {
    const f = gameData.factions[fid];
    if (!f) return;
    f.arsenal.guns = parseInt(document.getElementById('detailGuns').value) || 0;
    f.arsenal.horses = parseInt(document.getElementById('detailHorses').value) || 0;
    f.arsenal.cannons = parseInt(document.getElementById('detailCannons').value) || 0;
    f.soldiers.idle = parseInt(document.getElementById('detailIdle').value) || 0;
    if (!f.agriculture) f.agriculture = { points: 0 };
    if (!f.navy) f.navy = { points: 0 };
    if (!f.armament) f.armament = { points: 0 };
    f.agriculture.points = Math.min(100, Math.max(0, parseInt(document.getElementById('detailAgri').value) || 0));
    f.navy.points = Math.min(100, Math.max(0, parseInt(document.getElementById('detailNavy').value) || 0));
    f.armament.points = Math.min(100, Math.max(0, parseInt(document.getElementById('detailArma').value) || 0));
    addOperationLog('ç®¡ç†å‘˜', `ç¼–è¾‘åŠ¿åŠ›ã€${f.name}ã€‘è¯¦æƒ…`);
    closeModal();
    updateFactionsList();
}

function showAddSamuraiModal(fid) {
    openModal('æ·»åŠ æ­¦å£«', `
        <div class="form-group"><label>å§“å</label><input type="text" id="newSamName"></div>
        <div class="form-group"><label>ç±»å‹</label><select id="newSamType"><option>çŒ›å°†</option><option>æ™ºå°†</option><option>å‹‡å°†</option><option>å„’å°†</option></select></div>
        <div class="grid-2">
            <div class="form-group"><label>æ­¦åŠŸ</label><input type="number" id="newSamMartial" value="50" min="0" max="100"></div>
            <div class="form-group"><label>æ–‡æ²»</label><input type="number" id="newSamCivil" value="50" min="0" max="100"></div>
        </div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: `showFactionDetailModal('${fid}')` },
        { text: 'æ·»åŠ ', class: 'btn-success', action: `addSamurai('${fid}')` }
    ]);
}

function addSamurai(fid) {
    const f = gameData.factions[fid];
    const name = document.getElementById('newSamName').value.trim();
    if (!name) { alert('è¯·è¾“å…¥å§“å'); return; }
    f.samurai.push({
        name,
        type: document.getElementById('newSamType').value,
        martial: parseInt(document.getElementById('newSamMartial').value) || 50,
        civil: parseInt(document.getElementById('newSamCivil').value) || 50
    });
    addOperationLog('ç®¡ç†å‘˜', `ä¸ºã€${f.name}ã€‘æ·»åŠ æ­¦å£«ã€${name}ã€‘`);
    showFactionDetailModal(fid);
}

function removeSamurai(fid, idx) {
    const f = gameData.factions[fid];
    const name = f.samurai[idx].name;
    f.samurai.splice(idx, 1);
    addOperationLog('ç®¡ç†å‘˜', `ä»ã€${f.name}ã€‘ç§»é™¤æ­¦å£«ã€${name}ã€‘`);
    showFactionDetailModal(fid);
}

function deleteFaction(fid) {
    if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    const name = gameData.factions[fid].name;
    gameData.territories.forEach(t => { if (t.owner === fid) { t.owner = ''; t.garrison = ''; } });
    gameData.armies = gameData.armies.filter(a => a.faction !== fid);
    delete gameData.factions[fid];
    addOperationLog('ç®¡ç†å‘˜', `åˆ é™¤åŠ¿åŠ›ã€${name}ã€‘`);
    updateFactionsList();
}

// å…¨å†›å›¢ä¸€è§ˆ
function renderAdminArmies() {
    const panel = document.getElementById('panel-armies');
    panel.innerHTML = `
        <div class="toolbar">
            <input type="text" id="armySearch" placeholder="æœç´¢..." oninput="filterArmies()" style="width:150px">
        </div>
        <div class="table-wrapper"><div class="table-scroll" style="max-height:550px">
            <table>
                <thead><tr>
                    <th style="width:10%">æ‰€å±åŠ¿åŠ›</th>
                    <th style="width:12%">å†›å›¢åç§°</th>
                    <th style="width:10%">å°†é¢†</th>
                    <th style="width:8%">äººæ•°</th>
                    <th style="width:8%">é“ç‚®</th>
                    <th style="width:8%">æˆ˜é©¬</th>
                    <th style="width:8%">å¤§ç­’</th>
                    <th style="width:12%">ä½ç½®</th>
                    <th style="width:24%">æ“ä½œ</th>
                </tr></thead>
                <tbody id="armiesList"></tbody>
            </table>
        </div></div>
    `;
    updateArmiesList();
}

function updateArmiesList() {
    const search = (document.getElementById('armySearch')?.value || '').toLowerCase();
    const filtered = gameData.armies.filter(a => {
        const fn = gameData.factions[a.faction]?.name || '';
        return a.name.toLowerCase().includes(search) || a.general.toLowerCase().includes(search) || fn.toLowerCase().includes(search);
    });
    document.getElementById('armiesList').innerHTML = filtered.map(a => {
        const fn = gameData.factions[a.faction]?.name || '-';
        return `<tr>
            <td>${fn}</td>
            <td>${a.name}</td>
            <td>${a.general}</td>
            <td>${a.soldiers}</td>
            <td>${a.guns}</td>
            <td>${a.horses}</td>
            <td>${a.cannons}</td>
            <td>${a.location}</td>
            <td>
                <button class="btn btn-primary" onclick="showAdminEditArmy(${a.id})">ç¼–è¾‘</button>
                <button class="btn btn-danger" onclick="adminDeleteArmy(${a.id})">åˆ é™¤</button>
            </td>
        </tr>`;
    }).join('');
}

function filterArmies() { updateArmiesList(); }

function showAdminEditArmy(armyId) {
    const a = gameData.armies.find(army => army.id === armyId);
    if (!a) return;
    openModal('ç¼–è¾‘å†›å›¢', `
        <div class="grid-2">
            <div class="form-group"><label>å†›å›¢åç§°</label><input type="text" id="adminArmyName" value="${a.name}"></div>
            <div class="form-group"><label>å°†é¢†</label><input type="text" id="adminArmyGeneral" value="${a.general}"></div>
            <div class="form-group"><label>äººæ•°</label><input type="number" id="adminArmySoldiers" value="${a.soldiers}"></div>
            <div class="form-group"><label>é“ç‚®</label><input type="number" id="adminArmyGuns" value="${a.guns}"></div>
            <div class="form-group"><label>æˆ˜é©¬</label><input type="number" id="adminArmyHorses" value="${a.horses}"></div>
            <div class="form-group"><label>å¤§ç­’</label><input type="number" id="adminArmyCannons" value="${a.cannons}"></div>
            <div class="form-group"><label>ä½ç½®</label><input type="text" id="adminArmyLocation" value="${a.location}"></div>
        </div>
    `, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ä¿å­˜', class: 'btn-success', action: `saveAdminEditArmy(${armyId})` }
    ]);
}

function saveAdminEditArmy(armyId) {
    const a = gameData.armies.find(army => army.id === armyId);
    if (!a) return;
    a.name = document.getElementById('adminArmyName').value.trim();
    a.general = document.getElementById('adminArmyGeneral').value.trim();
    a.soldiers = parseInt(document.getElementById('adminArmySoldiers').value) || 0;
    a.guns = parseInt(document.getElementById('adminArmyGuns').value) || 0;
    a.horses = parseInt(document.getElementById('adminArmyHorses').value) || 0;
    a.cannons = parseInt(document.getElementById('adminArmyCannons').value) || 0;
    a.location = document.getElementById('adminArmyLocation').value.trim();
    addOperationLog('ç®¡ç†å‘˜', `ç¼–è¾‘å†›å›¢ã€${a.name}ã€‘`);
    closeModal();
    updateArmiesList();
}

function adminDeleteArmy(armyId) {
    if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    disbandArmy(armyId);
}

// è®°è´¦ä¸æ¨æ¼”
function renderAdminChronicle() {
    const panel = document.getElementById('panel-chronicle');
    panel.innerHTML = `
        <div class="grid-2">
            <div class="card">
                <div class="card-header">ğŸ“ å½•å…¥</div>
                <div class="card-body">
                    <div class="form-group"><label>å¹´ä»½</label><input type="number" id="chronicleYear" value="${gameData.currentYear}"></div>
                    <div class="form-group"><label>åŠ¿åŠ›</label><select id="chronicleFaction"><option value="">--é€‰æ‹©--</option>${Object.values(gameData.factions).map(f => `<option value="${f.name}">${f.name}</option>`).join('')}<option value="å…¨å±€">å…¨å±€äº‹ä»¶</option></select></div>
                    <div class="form-group"><label>å†…å®¹</label><textarea id="chronicleContent" rows="3"></textarea></div>
                    <div class="form-group"><label><input type="checkbox" id="chronicleCalc"> æ¶‰åŠæ•°å€¼å˜åŠ¨</label></div>
                    <button class="btn btn-success" onclick="saveChronicle()">ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="clearChronicleForm()">æ¸…ç©º</button>
                    <button class="btn btn-primary" onclick="updateGlobalYear()">æ›´æ–°å¹´ä»½</button>
                </div>
            </div>
            <div class="card">
                <div class="card-header">ğŸ“… æ¨æ¼”æ—¥å¿—</div>
                <div class="card-body">
                    <div class="toolbar">
                        <input type="text" id="chronicleFilterYear" placeholder="å¹´ä»½" style="width:80px">
                        <input type="text" id="chronicleFilterFaction" placeholder="åŠ¿åŠ›" style="width:80px">
                        <button class="btn btn-primary" onclick="filterChronicles()">ç­›é€‰</button>
                    </div>
                    <div class="table-wrapper"><div class="table-scroll" style="max-height:300px">
                        <table>
                            <thead><tr><th style="width:15%">å¹´ä»½</th><th style="width:20%">åŠ¿åŠ›</th><th style="width:45%">å†…å®¹</th><th style="width:20%">æ“ä½œ</th></tr></thead>
                            <tbody id="chroniclesList"></tbody>
                        </table>
                    </div></div>
                </div>
            </div>
        </div>
    `;
    updateChroniclesList();
}

function updateChroniclesList() {
    const yf = document.getElementById('chronicleFilterYear')?.value || '';
    const ff = document.getElementById('chronicleFilterFaction')?.value || '';
    let list = gameData.chronicles;
    if (yf) list = list.filter(c => c.year.toString().includes(yf));
    if (ff) list = list.filter(c => c.faction.includes(ff));
    document.getElementById('chroniclesList').innerHTML = list.map(c => `<tr>
        <td>${c.year}</td>
        <td>${c.faction}</td>
        <td title="${c.content}">${c.content.length > 20 ? c.content.substring(0, 20) + '...' : c.content}</td>
        <td><button class="btn btn-danger" onclick="deleteChronicle(${c.id})">åˆ é™¤</button></td>
    </tr>`).join('');
}

function saveChronicle() {
    const content = document.getElementById('chronicleContent').value.trim();
    if (!content) { alert('è¯·è¾“å…¥å†…å®¹'); return; }
    gameData.chronicles.unshift({
        id: gameData.nextChronicleId++,
        year: parseInt(document.getElementById('chronicleYear').value) || gameData.currentYear,
        faction: document.getElementById('chronicleFaction').value || 'æœªæŒ‡å®š',
        content,
        calculated: document.getElementById('chronicleCalc').checked
    });
    addOperationLog('ç®¡ç†å‘˜', `æ·»åŠ æ¨æ¼”è®°å½•`);
    clearChronicleForm();
    updateChroniclesList();
}

function clearChronicleForm() {
    document.getElementById('chronicleFaction').value = '';
    document.getElementById('chronicleContent').value = '';
    document.getElementById('chronicleCalc').checked = false;
}

function updateGlobalYear() {
    const year = parseInt(document.getElementById('chronicleYear').value);
    if (year) {
        gameData.currentYear = year;
        document.getElementById('currentYear').textContent = 'å¹´ä»½ï¼š' + year + 'å¹´';
        addOperationLog('ç®¡ç†å‘˜', `æ›´æ–°å¹´ä»½ä¸º${year}å¹´`);
        saveData();
    }
}

function filterChronicles() { updateChroniclesList(); }

function deleteChronicle(id) {
    if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    gameData.chronicles = gameData.chronicles.filter(c => c.id !== id);
    addOperationLog('ç®¡ç†å‘˜', 'åˆ é™¤æ¨æ¼”è®°å½•');
    updateChroniclesList();
}

// æŠ•èµ„ç³»ç»Ÿ
function renderAdminInvestment() {
    const panel = document.getElementById('panel-investment');
    panel.innerHTML = `
        <div class="card">
            <div class="card-header">ğŸ’° æŠ•èµ„æ“ä½œ</div>
            <div class="card-body">
                <div class="grid-2">
                    <div class="form-group"><label>é€‰æ‹©åŠ¿åŠ›</label><select id="investFaction" onchange="updateInvestSamurai()"><option value="">--é€‰æ‹©--</option>${Object.values(gameData.factions).map(f => `<option value="${f.id}">${f.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label>é€‰æ‹©æ­¦å£«</label><select id="investSamurai"><option value="">--å…ˆé€‰åŠ¿åŠ›--</option></select></div>
                    <div class="form-group"><label>æŠ•èµ„ç±»å‹</label><select id="investType">
                        <option value="agriculture">å†œä¸šï¼ˆ5000çŸ³ï¼Œæ–‡æ²»ï¼‰</option>
                        <option value="navy">æ°´å†›ï¼ˆ8000çŸ³ï¼Œæ­¦åŠŸï¼‰</option>
                        <option value="armament">æ­¦å¤‡ï¼ˆ4000çŸ³ï¼Œæ­¦åŠŸï¼‰</option>
                        <option value="commerce">å•†ä¸šï¼ˆè‡ªå®šé‡‘é¢ï¼Œæ–‡æ²»ï¼‰</option>
                    </select></div>
                    <div class="form-group" id="commerceOptions" style="display:none">
                        <label>ç›®æ ‡éƒ¡å›½</label><select id="investTarget"></select>
                    </div>
                    <div class="form-group" id="commerceAmount" style="display:none">
                        <label>æŠ•å…¥èµ„é‡‘</label><input type="number" id="investAmount" value="5000">
                    </div>
                </div>
                <button class="btn btn-success" onclick="executeInvestment()">æ‰§è¡ŒæŠ•èµ„</button>
                <div id="investResult" style="margin-top:15px;padding:10px;background:#f8f9fa;border-radius:5px;display:none"></div>
            </div>
        </div>
        <div class="card" style="margin-top:20px">
            <div class="card-header">ğŸ“Š æŠ•èµ„ç­‰çº§è¯´æ˜</div>
            <div class="card-body">
                <div class="grid-3">
                    <div>
                        <h4 style="color:var(--primary-color)">å†œä¸š</h4>
                        <p style="font-size:12px">LV0è’åºŸâ†’LV7ç‘ç©—<br>å½±å“è‡ªç„¶å¢é•¿ç‡å’ŒçŸ³é«˜åŠ æˆ</p>
                    </div>
                    <div>
                        <h4 style="color:var(--primary-color)">æ°´å†›</h4>
                        <p style="font-size:12px">LV0æ¸”èˆ¹â†’LV7é®å¤©è”½æ—¥<br>å½±å“æµ·æˆ˜èƒ½åŠ›</p>
                    </div>
                    <div>
                        <h4 style="color:var(--primary-color)">æ­¦å¤‡</h4>
                        <p style="font-size:12px">LV0æœ½åâ†’LV7æ­¦åº“<br>å½±å“è£…å¤‡ç»´æŠ¤è´¹</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById('investType').addEventListener('change', function() {
        const isCommerce = this.value === 'commerce';
        document.getElementById('commerceOptions').style.display = isCommerce ? 'block' : 'none';
        document.getElementById('commerceAmount').style.display = isCommerce ? 'block' : 'none';
        if (isCommerce) updateInvestTargets();
    });
}

function updateInvestSamurai() {
    const fid = document.getElementById('investFaction').value;
    const sel = document.getElementById('investSamurai');
    sel.innerHTML = '<option value="">--é€‰æ‹©--</option>';
    if (fid && gameData.factions[fid]) {
        gameData.factions[fid].samurai.forEach(s => {
            sel.innerHTML += `<option value="${s.name}">${s.name}(æ­¦${s.martial}/æ–‡${s.civil})</option>`;
        });
    }
}

function updateInvestTargets() {
    const fid = document.getElementById('investFaction').value;
    const sel = document.getElementById('investTarget');
    sel.innerHTML = '<option value="">--é€‰æ‹©--</option>';
    if (fid) {
        gameData.territories.filter(t => t.owner === fid).forEach(t => {
            sel.innerHTML += `<option value="${t.code}">${t.name}${t.developableProduct ? '(å¯å¼€å‘:' + t.developableProduct + ')' : ''}</option>`;
        });
    }
}

function executeInvestment() {
    const fid = document.getElementById('investFaction').value;
    const samurai = document.getElementById('investSamurai').value;
    const type = document.getElementById('investType').value;
    
    if (!fid || !samurai) { alert('è¯·é€‰æ‹©åŠ¿åŠ›å’Œæ­¦å£«'); return; }
    
    let result;
    if (type === 'commerce') {
        const target = document.getElementById('investTarget').value;
        const amount = parseInt(document.getElementById('investAmount').value) || 0;
        if (!target) { alert('è¯·é€‰æ‹©ç›®æ ‡éƒ¡å›½'); return; }
        if (amount < 1000) { alert('æŠ•å…¥èµ„é‡‘è‡³å°‘1000çŸ³'); return; }
        result = doCommerceInvestment(fid, samurai, target, amount);
    } else {
        result = doInvestment(fid, type, samurai);
    }
    
    const resultDiv = document.getElementById('investResult');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = result.success ? 
        `<span style="color:green">âœ“ ${result.msg}</span>` : 
        `<span style="color:red">âœ— ${result.msg}</span>`;
    
    if (result.success) {
        addOperationLog('ç®¡ç†å‘˜', `ã€${gameData.factions[fid].name}ã€‘${samurai}æ‰§è¡Œ${type}æŠ•èµ„ï¼š${result.msg}`);
        updateFactionsList();
    }
}

// æ•°æ®å¯¼å…¥
function renderAdminImport() {
    const panel = document.getElementById('panel-import');
    panel.innerHTML = `
        <div class="toolbar">
            <button class="btn btn-primary" onclick="showImportModal('territories')">å¯¼å…¥éƒ¡å›½</button>
            <button class="btn btn-primary" onclick="showImportModal('armies')">å¯¼å…¥å†›å›¢</button>
            <button class="btn btn-primary" onclick="showImportModal('factions')">å¯¼å…¥åŠ¿åŠ›</button>
        </div>
        <div class="card">
            <div class="card-header">ğŸ“‹ å¯¼å…¥è¯´æ˜</div>
            <div class="card-body">
                <p>1. ç‚¹å‡»æŒ‰é’®é€‰æ‹©å¯¼å…¥ç±»å‹</p>
                <p>2. åœ¨è¡¨æ ¼ä¸­å¡«å†™æ•°æ®ï¼Œæˆ–ä»Excelå¤åˆ¶ç²˜è´´</p>
                <p>3. ç‚¹å‡»ç¡®è®¤å¯¼å…¥</p>
                <p style="color:var(--warning-color);margin-top:10px">æç¤ºï¼šå¯ç›´æ¥ä»Excelå¤åˆ¶å¤šè¡Œæ•°æ®ç²˜è´´</p>
            </div>
        </div>
    `;
}

function showImportModal(type) {
    let headers = [], title = '';
    switch(type) {
        case 'territories':
            title = 'å¯¼å…¥éƒ¡å›½';
            headers = ['ä»£ç ', 'ä»¤åˆ¶å›½', 'éƒ¡å', 'åŸæ± ', 'ç­‰çº§', 'åŸºç¡€çŸ³é«˜', 'ç‰¹äº§1', 'ç‰¹äº§2', 'ç‰¹äº§3', 'å¯å‘å±•ç‰¹äº§', 'åŠ¿åŠ›ID', 'é©»å†›', 'ç®€ä»‹'];
            break;
        case 'armies':
            title = 'å¯¼å…¥å†›å›¢';
            headers = ['åŠ¿åŠ›ID', 'å†›å›¢åç§°', 'å°†é¢†', 'äººæ•°', 'é“ç‚®', 'æˆ˜é©¬', 'å¤§ç­’', 'ä½ç½®'];
            break;
        case 'factions':
            title = 'å¯¼å…¥åŠ¿åŠ›';
            headers = ['ID', 'åç§°', 'å®¶ä¸»', 'ä»£ç ', 'ç¨ç‡', 'äº§ä¸šçŸ³é«˜'];
            break;
    }
    
    let tableHtml = `
        <p style="margin-bottom:10px;font-size:12px;color:#666">åœ¨è¡¨æ ¼ä¸­å¡«å†™æˆ–ä»Excelç²˜è´´æ•°æ®</p>
        <div style="overflow-x:auto">
            <table class="import-table" id="importTable" style="border-collapse:collapse;width:100%">
                <thead><tr>${headers.map(h => `<th style="border:1px solid #ddd;padding:5px;background:#f5f5f5;font-size:12px">${h}</th>`).join('')}</tr></thead>
                <tbody>${Array(8).fill(0).map(() => `<tr>${headers.map(() => `<td style="border:1px solid #ddd;padding:2px"><input type="text" style="width:100%;border:none;padding:3px;font-size:12px"></td>`).join('')}</tr>`).join('')}</tbody>
            </table>
        </div>
        <button class="btn btn-secondary" onclick="addImportRow()" style="margin-top:10px">æ·»åŠ è¡Œ</button>
    `;
    
    openModal(title, tableHtml, [
        { text: 'å–æ¶ˆ', class: 'btn-secondary', action: 'closeModal()' },
        { text: 'ç¡®è®¤å¯¼å…¥', class: 'btn-success', action: `confirmImport('${type}')` }
    ]);
    
    setTimeout(() => {
        document.getElementById('importTable').addEventListener('paste', handlePaste);
    }, 100);
}

function addImportRow() {
    const tbody = document.querySelector('#importTable tbody');
    const cols = document.querySelectorAll('#importTable thead th').length;
    const row = document.createElement('tr');
    row.innerHTML = Array(cols).fill(0).map(() => `<td style="border:1px solid #ddd;padding:2px"><input type="text" style="width:100%;border:none;padding:3px;font-size:12px"></td>`).join('');
    tbody.appendChild(row);
}

function handlePaste(e) {
    e.preventDefault();
    const data = (e.clipboardData || window.clipboardData).getData('text');
    const rows = data.split('\\n').filter(r => r.trim());
    const tbody = document.querySelector('#importTable tbody');
    const cols = document.querySelectorAll('#importTable thead th').length;
    
    const active = document.activeElement;
    let startRow = 0, startCol = 0;
    if (active && active.tagName === 'INPUT') {
        const cell = active.closest('td');
        const row = cell.closest('tr');
        startRow = Array.from(tbody.querySelectorAll('tr')).indexOf(row);
        startCol = Array.from(row.querySelectorAll('td')).indexOf(cell);
    }
    
    rows.forEach((rowData, ri) => {
        const colData = rowData.split('\\t');
        const targetRow = startRow + ri;
        while (tbody.querySelectorAll('tr').length <= targetRow) addImportRow();
        const tr = tbody.querySelectorAll('tr')[targetRow];
        const inputs = tr.querySelectorAll('input');
        colData.forEach((val, ci) => {
            const targetCol = startCol + ci;
            if (targetCol < inputs.length) inputs[targetCol].value = val.trim();
        });
    });
}

function confirmImport(type) {
    const rows = document.querySelectorAll('#importTable tbody tr');
    let imported = 0;
    
    rows.forEach(row => {
        const inputs = row.querySelectorAll('input');
        const vals = Array.from(inputs).map(i => i.value.trim());
        if (vals.every(v => !v)) return;
        
        switch(type) {
            case 'territories':
                if (vals[0] && vals[2]) {
                    const existing = gameData.territories.findIndex(t => t.code === vals[0]);
                    const newT = {
                        code: vals[0], province: vals[1], name: vals[2], castle: vals[3],
                        castleLevel: parseInt(vals[4]) || 0, baseKoku: parseInt(vals[5]) || 0,
                        product1: vals[6], product2: vals[7], product3: vals[8],
                        developableProduct: vals[9], owner: vals[10], garrison: vals[11], description: vals[12]
                    };
                    if (existing > -1) gameData.territories[existing] = newT;
                    else gameData.territories.push(newT);
                    imported++;
                }
                break;
            case 'armies':
                if (vals[0] && vals[1]) {
                    gameData.armies.push({
                        id: gameData.nextArmyId++, faction: vals[0], name: vals[1], general: vals[2],
                        soldiers: parseInt(vals[3]) || 0, guns: parseInt(vals[4]) || 0,
                        horses: parseInt(vals[5]) || 0, cannons: parseInt(vals[6]) || 0, location: vals[7]
                    });
                    imported++;
                }
                break;
            case 'factions':
                if (vals[0] && vals[1] && vals[3]) {
                    gameData.factions[vals[0]] = {
                        id: vals[0], name: vals[1], lord: vals[2], code: vals[3],
                        taxRate: parseInt(vals[4]) || 60, industryKoku: parseInt(vals[5]) || 10000,
                        agriculture: { points: 15 }, commerce: { points: 0 }, navy: { points: 10 }, armament: { points: 15 },
                        arsenal: { guns: 0, horses: 0, cannons: 0 }, soldiers: { idle: 0 },
                        money: 0, buffs: [], samurai: [], diplomacy: []
                    };
                    imported++;
                }
                break;
        }
    });
    
    if (imported > 0) {
        addOperationLog('ç®¡ç†å‘˜', `å¯¼å…¥${imported}æ¡${type === 'territories' ? 'éƒ¡å›½' : type === 'armies' ? 'å†›å›¢' : 'åŠ¿åŠ›'}æ•°æ®`);
        alert(`æˆåŠŸå¯¼å…¥${imported}æ¡æ•°æ®`);
        closeModal();
        renderAdminView();
    } else {
        alert('æ²¡æœ‰æœ‰æ•ˆæ•°æ®');
    }
}

// æ“ä½œè®°å½•
function renderAdminLogs() {
    const panel = document.getElementById('panel-logs');
    panel.innerHTML = `
        <div class="toolbar">
            <input type="text" id="logFilter" placeholder="ç­›é€‰æ“ä½œäºº" style="width:150px">
            <button class="btn btn-primary" onclick="filterLogs()">ç­›é€‰</button>
            <button class="btn btn-secondary" onclick="clearLogFilter()">æ¸…é™¤</button>
        </div>
        <div class="table-wrapper"><div class="table-scroll" style="max-height:550px">
            <table>
                <thead><tr>
                    <th style="width:20%">æ—¶é—´</th>
                    <th style="width:15%">æ“ä½œäºº</th>
                    <th style="width:45%">å†…å®¹</th>
                    <th style="width:20%">æ“ä½œ</th>
                </tr></thead>
                <tbody id="logsList"></tbody>
            </table>
        </div></div>
    `;
    updateLogsList();
}

function updateLogsList() {
    const filter = document.getElementById('logFilter')?.value || '';
    let logs = gameData.operationLogs;
    if (filter) logs = logs.filter(l => l.operator.includes(filter));
    document.getElementById('logsList').innerHTML = logs.map((log, i) => `<tr>
        <td style="font-size:12px">${log.time}</td>
        <td>${log.operator}</td>
        <td title="${log.content}">${log.content.length > 30 ? log.content.substring(0, 30) + '...' : log.content}</td>
        <td>${i < 20 ? `<button class="btn btn-warning" onclick="rollbackTo(${i})">å›æº¯</button>` : ''}</td>
    </tr>`).join('');
}

function filterLogs() { updateLogsList(); }
function clearLogFilter() { document.getElementById('logFilter').value = ''; updateLogsList(); }

function rollbackTo(idx) {
    if (!confirm('ç¡®å®šå›æº¯åˆ°æ­¤æ—¶é—´ç‚¹ï¼Ÿå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼')) return;
    const log = gameData.operationLogs[idx];
    if (log && log.snapshot) {
        try {
            gameData = JSON.parse(log.snapshot);
            saveData();
            alert('æ•°æ®å·²å›æº¯');
            renderAdminView();
        } catch (e) {
            alert('å›æº¯å¤±è´¥');
        }
    }
}

// æ•°æ®å¤‡ä»½
function renderAdminBackup() {
    const panel = document.getElementById('panel-backup');
    panel.innerHTML = `
        <div class="card">
            <div class="card-header">ğŸ’¾ æ•°æ®å¤‡ä»½ä¸æ¢å¤</div>
            <div class="card-body">
                <div class="grid-2">
                    <div>
                        <h4 style="margin-bottom:10px;color:var(--primary-color)">å¯¼å‡ºæ•°æ®</h4>
                        <p style="margin-bottom:10px;font-size:13px;color:#666">å°†æ‰€æœ‰æ•°æ®å¯¼å‡ºä¸ºJSONæ–‡ä»¶</p>
                        <button class="btn btn-success" onclick="exportData()">å¯¼å‡ºæ•°æ®</button>
                    </div>
                    <div>
                        <h4 style="margin-bottom:10px;color:var(--primary-color)">å¯¼å…¥æ•°æ®</h4>
                        <p style="margin-bottom:10px;font-size:13px;color:#666">ä»JSONæ–‡ä»¶æ¢å¤æ•°æ®</p>
                        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importDataFile(event)">
                        <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">å¯¼å…¥æ•°æ®</button>
                    </div>
                </div>
                <hr style="margin:20px 0">
                <h4 style="margin-bottom:10px;color:var(--danger-color)">å±é™©æ“ä½œ</h4>
                <button class="btn btn-danger" onclick="resetAllData()">é‡ç½®æ‰€æœ‰æ•°æ®</button>
            </div>
        </div>
        <div class="card" style="margin-top:20px">
            <div class="card-header">ğŸ“Š æ•°æ®ç»Ÿè®¡</div>
            <div class="card-body">
                <div class="grid-4">
                    <div class="info-item"><span class="label">åŠ¿åŠ›</span><span class="value">${Object.keys(gameData.factions).length}</span></div>
                    <div class="info-item"><span class="label">é¢†åœ°</span><span class="value">${gameData.territories.length}</span></div>
                    <div class="info-item"><span class="label">å†›å›¢</span><span class="value">${gameData.armies.length}</span></div>
                    <div class="info-item"><span class="label">ç‰¹äº§</span><span class="value">${Object.keys(gameData.products).length}</span></div>
                </div>
            </div>
        </div>
    `;
}

function exportData() {
    const blob = new Blob([JSON.stringify(gameData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ä¸‹å…‹ä¸Šå­˜æ¡£_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    addOperationLog('ç®¡ç†å‘˜', 'å¯¼å‡ºæ•°æ®');
}

function importDataFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (!confirm('å¯¼å…¥å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šï¼Ÿ')) return;
            gameData = data;
            saveData();
            addOperationLog('ç®¡ç†å‘˜', 'å¯¼å…¥æ•°æ®');
            alert('å¯¼å…¥æˆåŠŸ');
            renderAdminView();
        } catch (err) {
            alert('æ–‡ä»¶æ ¼å¼é”™è¯¯');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function resetAllData() {
    if (!confirm('ç¡®å®šé‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿ')) return;
    if (!confirm('å†æ¬¡ç¡®è®¤ï¼')) return;
    gameData = JSON.parse(JSON.stringify(DEFAULT_DATA));
    saveData();
    alert('æ•°æ®å·²é‡ç½®');
    renderAdminView();
}

// ==================== é€šç”¨åŠŸèƒ½ ====================
function openModal(title, body, buttons) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalBody').innerHTML = body;
    document.getElementById('modalFooter').innerHTML = buttons.map(b => `<button class="btn ${b.class}" onclick="${b.action}">${b.text}</button>`).join('');
    document.getElementById('modal').classList.add('active');
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
}

function syncSlider(sliderId, value, min, max) {
    let v = parseInt(value) || 0;
    if (v < min) v = min;
    if (v > max) v = max;
    document.getElementById(sliderId).value = v;
    event.target.value = v;
}

document.getElementById('modal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

document.getElementById('loginCode').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') handleLogin();
});

init();
</script>
</body>
</html>
