# 下克上小助手v0.01内测版 - 完整需求与实现文档

**项目名称：** 下克上小助手v0.01内测版  
**开发者：** 路人小狼  
**文档版本：** v1.0  
**更新日期：** 2024年12月

---

## 目录

1. [项目概述](#项目概述)
2. [系统架构](#系统架构)
3. [登录与权限系统](#登录与权限系统)
4. [玩家端功能](#玩家端功能)
5. [管理员端功能](#管理员端功能)
6. [经济计算系统](#经济计算系统)
7. [投资系统](#投资系统)
8. [回合结算机制](#回合结算机制)
9. [数据结构设计](#数据结构设计)
10. [技术实现细节](#技术实现细节)
11. [用户界面设计](#用户界面设计)
12. [测试与部署](#测试与部署)

---

## 1. 项目概述

### 1.1 项目背景
下克上小助手是一个专为文字游戏推演设计的联网HTML单页应用，主要用于管理战国时代的势力、领地、军团等游戏要素，支持多人协作和实时数据同步。

### 1.2 核心特性
- **单页面应用**：无需安装，双击HTML文件即可运行
- **联网功能**：支持多人通过链接访问同一数据
- **数据持久化**：使用浏览器LocalStorage存储数据
- **权限分级**：管理员和玩家两种权限模式
- **经济系统**：完整的石高、收入、支出计算体系
- **投资系统**：农业、水军、武备、商业四大投资方向
- **回合制**：支持年度结算和数据更新

### 1.3 目标用户
- 文字游戏主持人（管理员）
- 参与游戏的玩家（势力管理者）
- 需要协作管理复杂数据的团队

---

## 2. 系统架构

### 2.1 技术架构
```
前端展示层
├── HTML5 + CSS3 + JavaScript
├── 响应式设计
└── 模态框交互

数据存储层
├── LocalStorage（主要存储）
├── JSON格式数据
└── 导入/导出功能

业务逻辑层
├── 经济计算引擎
├── 投资系统
├── 权限管理
└── 数据验证
```

### 2.2 文件结构
```
下克上小助手.html
├── HTML结构
├── CSS样式
├── JavaScript逻辑
└── 数据结构定义
```

### 2.3 数据流向
```
用户操作 → 前端验证 → 业务逻辑处理 → 数据更新 → LocalStorage存储 → 界面刷新
```

---

## 3. 登录与权限系统

### 3.1 登录机制
#### 3.1.1 代码登录
- **管理员代码**：`admin`（固定）
- **势力代码**：可由管理员自定义（如`oda`、`takeda`）
- **登录流程**：输入代码 → 验证 → 分配权限 → 进入对应界面

#### 3.1.2 权限分级
| 权限类型 | 登录代码 | 功能权限 |
|---------|---------|---------|
| 管理员 | admin | 全部数据的增删改查、系统管理 |
| 玩家 | 势力代码 | 仅能操作所属势力数据 |

### 3.2 联网链接功能
- **分享机制**：管理员可复制当前页面URL
- **访问方式**：其他用户通过链接直接访问
- **数据同步**：基于LocalStorage，需手动导入/导出同步

### 3.3 会话管理
- **登录状态**：保持在浏览器会话中
- **自动登出**：刷新页面需重新登录
- **权限验证**：每次操作都验证当前用户权限

---

## 4. 玩家端功能

### 4.1 势力信息展示

#### 4.1.1 基础信息
- **势力名称**：如"织田家"
- **家主姓名**：如"织田信长"
- **石高数据**：
  - 领地石高：所有领地基础石高之和
  - 特产石高：特产带来的额外石高
  - 整合奖励：完全占领令制国的奖励
  - 产业石高：家族产业（默认1万石）
  - 表面石高：最终显示的总石高

#### 4.1.2 经济数据
- **税率**：40%/60%/80%三档，影响收入和士兵上限
- **年收入**：表面石高 × 税率 × 0.4
- **年支出**：各项维护费用总和
- **净收入**：收入减去支出
- **现有资金**：当前可用资金

#### 4.1.3 军事数据
- **武库库存**：铁炮、战马、大筒数量
- **士兵情况**：
  - 总兵力：闲置+军团士兵总数
  - 闲置士兵：未编入军团的士兵
  - 士兵上限：基于领地石高和税率计算
  - 维持比：当前士兵/士兵上限

### 4.2 发展系统展示

#### 4.2.1 投资等级
| 系统 | 等级范围 | 显示方式 |
|------|---------|---------|
| 农业 | LV0荒废 - LV7瑞穗 | 等级徽章+进度条 |
| 水军 | LV0渔船 - LV7遮天蔽日 | 等级徽章+进度条 |
| 武备 | LV0朽坏 - LV7武库 | 等级徽章+进度条 |

#### 4.2.2 效果说明
- **农业**：影响自然增长率和石高加成
- **水军**：影响海战能力（主要用于推演参考）
- **武备**：影响装备维护费用

### 4.3 玩家操作功能

#### 4.3.1 士兵招募
- **触发条件**：点击"招募士兵"按钮
- **操作界面**：滑条+数字输入框组合
- **限制条件**：不能超过士兵上限
- **资源消耗**：招募本身不消耗资金
- **结果**：增加闲置士兵数量

#### 4.3.2 军团建立
- **基本信息**：
  - 军团名称：1-8个中文字符
  - 选择将领：从闲置武士中选择
  - 军团人数：从闲置士兵中分配
  - 装备配置：铁炮、战马、大筒
  - 创建位置：选择己方领地

- **验证机制**：
  - 名称格式校验：必须为中文字符
  - 将领唯一性：一个将领只能指挥一个军团
  - 资源充足性：不能超过库存

- **冲突处理**：
  - 将领已任职：提示是否调任
  - 原军团处理：指派新将领或解散

#### 4.3.3 军团管理
- **编辑人数**：调整军团士兵数量
- **编辑装备**：调整铁炮、战马、大筒配置
- **解散军团**：返还所有资源到库存

#### 4.3.4 装备购买
- **购买价格**：
  - 铁炮：10石/挺
  - 战马：12石/匹
  - 大筒：450石/门
- **资金检查**：确保有足够资金
- **库存更新**：直接增加到武库

### 4.4 信息查看功能

#### 4.4.1 上级武士列表
- **显示信息**：姓名、类型、武功、文治、当前状态
- **状态类型**：闲置、指挥某军团
- **表格格式**：固定表头、可滚动内容

#### 4.4.2 领地列表
- **显示字段**：
  - 郡国代码：如WEIZH01
  - 令制国：如尾张国
  - 郡名：如春日井郡
  - 城池：城池名称和等级
  - 基础石高：该郡的基础产出
  - 特产1/2/3：已开发的特产
  - 驻军：驻扎的军团名称

#### 4.4.3 军团列表
- **显示信息**：军团名称、将领、人数、装备、位置
- **操作按钮**：每行都有"管理"按钮
- **交互方式**：点击管理进入军团操作菜单

#### 4.4.4 外交关系
- **关系类型**：同盟、敌对、友好、中立
- **颜色标识**：不同关系用不同颜色显示
- **简单展示**：目标势力名称+当前关系

#### 4.4.5 支出明细
- **详细分类**：
  - 士兵维护：总士兵数 × 4石
  - 战马维护：总战马数 × 12石 × 武备系数
  - 铁炮维护：总铁炮数 × 3石 × 武备系数
  - 大筒维护：总大筒数 × 8石 × 武备系数
  - 军团出征费：军团士兵数 × 4石
  - 武士俸禄：武士数量 × 2000石

---

## 5. 管理员端功能

### 5.1 郡国数据管理

#### 5.1.1 数据字段规范
- **郡国代码**：令制国拼音前两字母+数字编号
  - 示例：若狭国某郡 = RUXI01
  - 规则：避免首字母重复，如日向(RIXI)与若狭(RUXI)区分
- **完整字段列表**：
  - 郡国代码、令制国、郡名
  - 城池名称、城池等级(1-7)
  - 基础石高
  - 特产1、特产2、特产3
  - 可发展特产
  - 所属势力、驻扎军团
  - 简介(50-80字)

#### 5.1.2 操作功能
- **新增领地**：填写完整信息创建新郡国
- **编辑领地**：修改任意字段信息
- **删除领地**：移除郡国数据
- **搜索筛选**：按代码、郡名、令制国搜索
- **简介展开**：点击查看完整简介，自动收起其他

#### 5.1.3 表格显示
- **固定表头**：滚动时表头不动
- **列宽优化**：确保所有信息都能正常显示
- **对齐修复**：表头与数据行严格对齐
- **操作按钮**：每行都有编辑、删除按钮

### 5.2 特产对照表管理

#### 5.2.1 特产数据结构
```javascript
{
  name: "特产名称",
  koku: 每年石高产出,
  horses: 每年战马产出,
  soldiers: 士兵上限增加,
  kokuBonus: 石高加成百分比,
  effect: "其他效果描述"
}
```

#### 5.2.2 系统机制
- **自动检测**：系统读取郡国中的特产名称
- **效果计算**：根据对照表返回具体数值
- **动态更新**：修改特产数据立即影响相关计算

#### 5.2.3 管理功能
- **新增特产**：创建新的特产类型
- **编辑特产**：修改特产的各项数值
- **删除特产**：移除特产（需确认无郡国使用）

### 5.3 势力管理

#### 5.3.1 基础信息管理
- **势力标识**：ID、名称、家主、登录代码
- **经济设置**：税率、产业石高、当前资金
- **发展等级**：农业、水军、武备点数

#### 5.3.2 详细数据管理
- **武库管理**：铁炮、战马、大筒库存
- **士兵管理**：闲置士兵数量
- **武士管理**：
  - 添加武士：姓名、类型、武功、文治
  - 删除武士：从列表中移除
  - 属性编辑：修改武功文治数值

#### 5.3.3 势力操作
- **新增势力**：创建新的可玩势力
- **编辑势力**：修改基础信息
- **删除势力**：移除势力及相关数据

### 5.4 全军团一览

#### 5.4.1 显示信息
- **所属势力**：军团归属的势力名称
- **军团详情**：名称、将领、人数、装备
- **位置信息**：当前驻扎的郡国
- **操作权限**：管理员可直接编辑任意军团

#### 5.4.2 管理功能
- **搜索筛选**：按军团名、将领名、势力名搜索
- **直接编辑**：修改军团的任意属性
- **强制删除**：删除违规或错误的军团

### 5.5 记账与推演

#### 5.5.1 录入功能
- **年份管理**：设置当前游戏年份
- **势力选择**：选择事件涉及的势力
- **内容记录**：详细的事件描述
- **数值标记**：标记是否涉及数值变动

#### 5.5.2 日志管理
- **筛选功能**：按年份、势力筛选记录
- **删除功能**：移除不需要的记录
- **全局年份**：更新系统当前年份

### 5.6 投资系统管理

#### 5.6.1 投资执行
- **势力选择**：选择执行投资的势力
- **武士选择**：选择执行投资的武士
- **投资类型**：农业、水军、武备、商业
- **结果显示**：显示投资结果和获得点数

#### 5.6.2 商业投资特殊处理
- **目标选择**：选择要开发的郡国
- **资金投入**：自定义投入金额
- **成功判定**：基于武士文治和投入资金
- **结果处理**：成功则开发特产，失败则消耗资金

### 5.7 数据导入功能

#### 5.7.1 导入类型
- **郡国导入**：批量导入郡国数据
- **军团导入**：批量导入军团数据
- **势力导入**：批量导入势力数据

#### 5.7.2 导入方式
- **表格填写**：在弹出的表格中手动填写
- **Excel粘贴**：从Excel复制数据直接粘贴
- **自动解析**：系统自动解析粘贴的数据

#### 5.7.3 数据验证
- **格式检查**：确保数据格式正确
- **重复检查**：避免重复数据
- **关联检查**：确保外键关系正确

### 5.8 操作记录

#### 5.8.1 记录机制
- **自动记录**：所有操作都自动记录
- **记录内容**：时间、操作人、操作内容、数据快照
- **存储限制**：最多保留100条记录

#### 5.8.2 回溯功能
- **回溯范围**：最近20条操作可回溯
- **数据恢复**：完全恢复到指定时间点的数据状态
- **确认机制**：回溯前需要二次确认

### 5.9 数据备份

#### 5.9.1 导出功能
- **完整导出**：导出所有游戏数据为JSON文件
- **文件命名**：自动生成带日期的文件名
- **数据完整性**：确保导出数据的完整性

#### 5.9.2 导入功能
- **文件选择**：选择JSON格式的备份文件
- **数据覆盖**：导入会覆盖当前所有数据
- **错误处理**：处理文件格式错误等异常情况

#### 5.9.3 重置功能
- **完全重置**：恢复到系统默认状态
- **二次确认**：防止误操作的安全机制

---

## 6. 经济计算系统

### 6.1 石高体系

#### 6.1.1 石高分类
1. **领地石高（基础石高）**
   - 定义：所有领地郡国的基础石高之和
   - 作用：决定士兵招募上限
   - 计算：∑(各郡基础石高)

2. **特产石高**
   - 定义：特产带来的额外石高产出
   - 特点：不受任何加成影响
   - 计算：∑(各特产的石高产出)

3. **领内财产（整合奖励）**
   - 定义：完全占领令制国后的固定奖励
   - 判定标准：占领该国90%以上的基础石高
   - 奖励标准：
     - 石高≥30万的令制国：+2万石
     - 石高15-30万的令制国：+1万石

4. **产业石高**
   - 定义：每个势力自带的家族产业
   - 默认值：1万石
   - 特点：不受加成影响，不增加士兵上限

#### 6.1.2 表面石高计算
```
表面石高 = 领地石高 × (1 + 加成系数) + 特产石高 + 领内财产 + 产业石高
```

### 6.2 加成系数计算

#### 6.2.1 士兵维持比影响
士兵维持比 = (闲置士兵 + 军团士兵) ÷ 士兵上限

| 维持比区间 | 石高加成 | 自然增长率 | 状态描述 |
|-----------|---------|-----------|---------|
| 0% - 20% | +12% | +3% | 休养生息 |
| 21% - 45% | +6% | +1% | 正常发展 |
| 46% - 60% | 0% | -1% | 普遍做法 |
| 61% - 80% | -10% | -2% | 穷兵黩武 |
| 81% - 94% | -20% | -4% | 暴君 |
| 95% - 100% | -30% | -8% | 领地倒退 |
| >100% | 触发叛乱 | - | 系统警告 |

#### 6.2.2 农业系统影响
农业等级基于投资点数(0-100)：

| 等级 | 点数范围 | 名称 | 自然增长率 | 石高加成 |
|------|---------|------|-----------|---------|
| LV0 | 0 | 荒废 | -1% | -5% |
| LV1 | 1-15 | 开垦 | 0% | 0% |
| LV2 | 16-30 | 井田 | +0.5% | 0% |
| LV3 | 31-50 | 检地 | +1% | +2% |
| LV4 | 51-70 | 治水 | +1.5% | +4% |
| LV5 | 71-85 | 丰饶 | +2% | +6% |
| LV6 | 86-99 | 天府 | +2.5% | +8% |
| LV7 | 100 | 瑞穗 | +3% | +10% |

#### 6.2.3 最终加成系数
```
加成系数 = 士兵维持比加成 + 农业系统加成
```

### 6.3 收入计算

#### 6.3.1 基础收入公式
```
年收入 = 表面石高 × 税率 × 0.4
```
- 0.4系数：代表扣除60%作为发展维持开支

#### 6.3.2 税率与士兵上限关系
| 税率 | 招募系数 | 说明 |
|------|---------|------|
| 40% | 230 | 低税收，高士兵上限 |
| 60% | 200 | 标准税收 |
| 80% | 180 | 高税收，低士兵上限 |

士兵上限计算：
```
士兵上限 = (领地石高 ÷ 10000) × 招募系数 + 特产士兵加成
```

### 6.4 支出计算

#### 6.4.1 基础维护费
| 单位类型 | 年维护费 |
|---------|---------|
| 步卒 | 4石/人 |
| 战马 | 12石/匹 |
| 铁炮 | 3石/挺 |
| 大筒 | 8石/门 |

#### 6.4.2 武备系统影响
武备等级影响装备维护费：

| 等级 | 点数范围 | 名称 | 维护费修正 |
|------|---------|------|-----------|
| LV0 | 0 | 朽坏 | +20% |
| LV1 | 1-15 | 普通 | 0% |
| LV2 | 16-30 | 整修 | -5% |
| LV3 | 31-50 | 精良 | -10% |
| LV4 | 51-70 | 军械 | -20% |
| LV5 | 71-85 | 严整 | -30% |
| LV6 | 86-99 | 兵法 | -40% |
| LV7 | 100 | 武库 | -50% |

#### 6.4.3 其他支出
- **军团出征费**：军团士兵数 × 4石/年
- **武士俸禄**：武士数量 × 2000石/年

#### 6.4.4 总支出计算
```
总支出 = 士兵维护费 + 装备维护费 × (1 + 武备修正) + 军团出征费 + 武士俸禄
```

### 6.5 净收入计算
```
净收入 = 年收入 - 总支出
```

---

## 7. 投资系统

### 7.1 通用判定机制

#### 7.1.1 核心规则
所有积累型投资（农业、水军、武备）遵循统一逻辑：

1. **属性阈值**：基准属性值为70点
2. **修正系数**：1 + (武士属性 - 70) × 1%
3. **随机判定**：D100系统（1-100随机数）
4. **成功率**：50% + (武士属性 - 70)%，限制在5%-95%

#### 7.1.2 判定结果
- **大成功**（随机数 < 5）：获得点数 = 基础点数 × 修正系数 × 1.5
- **成功**（随机数 < 成功率）：获得点数 = 基础点数 × 修正系数 × 1.0
- **失败**（随机数 > 成功率）：获得点数 = 基础点数 × 修正系数 × 0.5

### 7.2 农业系统

#### 7.2.1 基础参数
- **投资成本**：5000石
- **关联属性**：文治
- **基础点数**：5点
- **系统类型**：高投入、长周期、增加士兵上限

#### 7.2.2 等级效果
详见经济计算系统中的农业等级表。

### 7.3 水军系统

#### 7.3.1 基础参数
- **投资成本**：8000石
- **关联属性**：武功
- **基础点数**：4点
- **系统类型**：极高投入、纯军事用途

#### 7.3.2 等级划分
| 等级 | 点数范围 | 名称 |
|------|---------|------|
| LV0 | 0-10 | 纯纯渔船 |
| LV1 | 11-20 | 小队水军 |
| LV2 | 21-35 | 常规水军 |
| LV3 | 36-50 | 大队水军 |
| LV4 | 51-70 | 铁甲船 |
| LV5 | 71-85 | 水上霸主 |
| LV6 | 86-99 | 疾风怒涛 |
| LV7 | 100 | 遮天蔽日 |

### 7.4 武备系统

#### 7.4.1 基础参数
- **投资成本**：4000石
- **关联属性**：武功
- **基础点数**：6点
- **系统类型**：中等投入、后期经济型、降低维护费

#### 7.4.2 等级效果
详见经济计算系统中的武备等级表。

### 7.5 商业系统

#### 7.5.1 独特机制
商业系统采用特产探明机制，不同于其他积累型系统：

- **投资方式**：指定武士、目标郡国、投入资金
- **成功率计算**：(武士文治 - 50)% + (投入资金 ÷ 1000)%
- **结果类型**：特产开发，非点数积累

#### 7.5.2 判定流程
1. **情况A**（目标地无特产但成功）：
   - 反馈："此地并无新商机"
   - 结果：资金消耗，无收益

2. **情况B**（目标地有特产且成功）：
   - 反馈："开发了特产【名称】，下月起开始产出收益"
   - 结果：将可发展特产添加到特产列表

3. **情况C**（目标地有特产但失败）：
   - 反馈："似乎有关于【名称】的传闻，但投入资金不足"
   - 结果：资金消耗，提供情报价值

4. **情况D**（目标地无特产且失败）：
   - 反馈："没有打探到有价值的情报"
   - 结果：资金消耗，无收益

### 7.6 投资执行流程

#### 7.6.1 前置条件检查
- 势力资金充足
- 武士存在且可用
- 目标有效（商业投资）

#### 7.6.2 执行步骤
1. 扣除投资成本
2. 计算成功率和修正系数
3. 执行D100判定
4. 根据结果增加点数或开发特产
5. 记录操作日志
6. 更新界面显示

---

## 8. 回合结算机制

### 8.1 结算触发

#### 8.1.1 触发条件
- 管理员点击"下一年"按钮
- 系统弹出确认提醒
- 确认后自动执行所有结算逻辑

#### 8.1.2 结算内容
1. 根据士兵维持比和农业等级更新所有郡国石高
2. 计算并发放年度收入
3. 扣除所有维护费用
4. 检查叛乱条件
5. 更新全局年份

### 8.2 石高更新机制

#### 8.2.1 自然增长率计算
```
总增长率 = 士兵维持比增长率 + 农业系统增长率
```

#### 8.2.2 石高更新公式
```
新石高 = 原石高 × (1 + 总增长率)
最低限制 = 1000石（防止石高过低）
```

### 8.3 收入发放

#### 8.3.1 计算流程
1. 重新计算每个势力的表面石高
2. 根据税率计算年收入
3. 将收入添加到势力资金中

### 8.4 维护费扣除

#### 8.4.1 扣除项目
- 所有士兵的基础维护费
- 所有装备的维护费（考虑武备加成）
- 军团的额外出征费
- 武士的俸禄

#### 8.4.2 扣除顺序
1. 计算总维护费
2. 从势力资金中扣除
3. 如果资金不足，记录负债但不阻止结算

### 8.5 特殊事件检查

#### 8.5.1 叛乱检查
- 条件：士兵维持比 > 100%
- 结果：系统警告，记录到结算报告

#### 8.5.2 结算报告
每个势力生成结算报告：
- 收入金额
- 支出金额
- 净收入
- 石高增长率
- 特殊事件（如叛乱）

---

## 9. 数据结构设计

### 9.1 全局数据结构

```javascript
const gameData = {
  version: "版本号",
  currentYear: 当前年份,
  
  // 特产对照表
  products: {
    "特产名": {
      name: "特产名称",
      koku: 年石高产出,
      horses: 年战马产出,
      soldiers: 士兵上限增加,
      kokuBonus: 石高加成百分比,
      effect: "其他效果描述"
    }
  },
  
  // 令制国数据
  provinces: {
    "国名": {
      koku: 总石高,
      code: "代码前缀"
    }
  },
  
  // 势力数据
  factions: {},
  
  // 领地数据
  territories: [],
  
  // 军团数据
  armies: [],
  
  // 推演日志
  chronicles: [],
  
  // 操作记录
  operationLogs: [],
  
  // ID计数器
  nextArmyId: 下一个军团ID,
  nextChronicleId: 下一个日志ID
}
```

### 9.2 势力数据结构

```javascript
const faction = {
  id: "势力ID",
  name: "势力名称",
  lord: "家主姓名",
  code: "登录代码",
  taxRate: 税率,
  industryKoku: 产业石高,
  
  // 投资系统
  agriculture: { points: 农业点数 },
  commerce: { points: 商业点数 },
  navy: { points: 水军点数 },
  armament: { points: 武备点数 },
  
  // 军事资源
  arsenal: {
    guns: 铁炮数量,
    horses: 战马数量,
    cannons: 大筒数量
  },
  
  soldiers: {
    idle: 闲置士兵,
    total: 总士兵数
  },
  
  money: 当前资金,
  buffs: [增益列表],
  
  // 人员
  samurai: [
    {
      name: "武士姓名",
      type: "类型",
      martial: 武功值,
      civil: 文治值
    }
  ],
  
  // 外交
  diplomacy: [
    {
      target: "目标势力",
      relation: "关系类型"
    }
  ]
}
```

### 9.3 领地数据结构

```javascript
const territory = {
  code: "郡国代码",
  province: "令制国",
  name: "郡名",
  castle: "城池名称",
  castleLevel: 城池等级,
  baseKoku: 基础石高,
  product1: "特产1",
  product2: "特产2", 
  product3: "特产3",
  developableProduct: "可发展特产",
  owner: "所属势力ID",
  garrison: "驻扎军团",
  description: "简介"
}
```

### 9.4 军团数据结构

```javascript
const army = {
  id: 军团ID,
  faction: "所属势力ID",
  name: "军团名称",
  general: "将领姓名",
  soldiers: 士兵数量,
  guns: 铁炮数量,
  horses: 战马数量,
  cannons: 大筒数量,
  location: "当前位置"
}
```

### 9.5 操作记录结构

```javascript
const operationLog = {
  time: "操作时间",
  operator: "操作人",
  content: "操作内容",
  snapshot: "数据快照JSON字符串"
}
```

---

## 10. 技术实现细节

### 10.1 前端技术栈

#### 10.1.1 HTML5
- 语义化标签使用
- 响应式meta标签
- 无障碍访问支持

#### 10.1.2 CSS3
- CSS Grid和Flexbox布局
- CSS变量统一主题色彩
- 响应式设计
- 动画和过渡效果

#### 10.1.3 JavaScript ES6+
- 模块化代码组织
- 箭头函数和模板字符串
- Promise和async/await
- 解构赋值和扩展运算符

### 10.2 数据存储

#### 10.2.1 LocalStorage
- 主要存储方案
- JSON序列化存储
- 自动保存机制
- 版本兼容处理

#### 10.2.2 数据同步
- 导出/导入JSON文件
- 手动数据同步
- 版本控制和迁移

### 10.3 核心算法实现

#### 10.3.1 经济计算引擎
```javascript
function calcFactionEconomy(factionId) {
  // 1. 计算各类石高
  const territoryKoku = calcTerritoryKoku(factionId);
  const productKoku = calcProductKoku(factionId);
  const integrationBonus = calcIntegrationBonus(factionId);
  
  // 2. 计算加成系数
  const soldierRatio = calcSoldierRatio(factionId);
  const ratioEffect = getSoldierRatioEffect(soldierRatio);
  const agriEffect = getAgricultureEffect(faction.agriculture.points);
  const bonusCoef = ratioEffect.kokuBonus + agriEffect.kokuBonus;
  
  // 3. 计算表面石高
  const surfaceKoku = territoryKoku * (1 + bonusCoef) + productKoku + integrationBonus + industryKoku;
  
  // 4. 计算收入支出
  const income = surfaceKoku * taxRate * 0.4;
  const maintenance = calcMaintenance(factionId);
  const netIncome = income - maintenance;
  
  return { /* 完整经济数据 */ };
}
```

#### 10.3.2 投资判定系统
```javascript
function doInvestment(factionId, type, samuraiName) {
  // 1. 验证前置条件
  const faction = getFaction(factionId);
  const samurai = getSamurai(samuraiName);
  const cost = getInvestmentCost(type);
  
  if (faction.money < cost) return { success: false, msg: "资金不足" };
  
  // 2. 计算成功率和修正系数
  const attr = getRelevantAttribute(samurai, type);
  const modifier = 1 + (attr - 70) * 0.01;
  const successRate = Math.max(5, Math.min(95, 50 + (attr - 70)));
  
  // 3. D100判定
  const roll = Math.floor(Math.random() * 100) + 1;
  let multiplier = 0.5; // 默认失败
  if (roll < 5) multiplier = 1.5; // 大成功
  else if (roll <= successRate) multiplier = 1.0; // 成功
  
  // 4. 计算结果
  const basePoints = getBasePoints(type);
  const points = Math.round(basePoints * modifier * multiplier);
  
  // 5. 更新数据
  faction.money -= cost;
  faction[type].points = Math.min(100, faction[type].points + points);
  
  return { success: true, points, roll, successRate };
}
```

### 10.4 用户界面实现

#### 10.4.1 模态框系统
```javascript
function openModal(title, bodyHtml, buttons) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHtml;
  document.getElementById('modalFooter').innerHTML = buttons.map(btn => 
    `<button class="btn ${btn.class}" onclick="${btn.action}">${btn.text}</button>`
  ).join('');
  document.getElementById('modal').classList.add('active');
}
```

#### 10.4.2 表格渲染系统
```javascript
function renderTable(containerId, data, columns, options = {}) {
  const container = document.getElementById(containerId);
  const tableHtml = `
    <div class="table-wrapper">
      <div class="table-scroll" style="max-height: ${options.maxHeight || '400px'}">
        <table>
          <thead>
            <tr>${columns.map(col => `<th style="width:${col.width}">${col.title}</th>`).join('')}</tr>
          </thead>
          <tbody>
            ${data.map(row => `<tr>${columns.map(col => `<td>${col.render ? col.render(row) : row[col.field]}</td>`).join('')}</tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  container.innerHTML = tableHtml;
}
```

#### 10.4.3 滑条组合控件
```javascript
function createSliderGroup(id, min, max, value, label) {
  return `
    <div class="form-group">
      <label>${label}</label>
      <div class="slider-group">
        <input type="range" id="${id}Slider" min="${min}" max="${max}" value="${value}" 
               oninput="document.getElementById('${id}Input').value = this.value">
        <input type="number" id="${id}Input" min="${min}" max="${max}" value="${value}"
               oninput="syncSlider('${id}Slider', this.value, ${min}, ${max})">
      </div>
    </div>
  `;
}
```

### 10.5 数据验证

#### 10.5.1 输入验证
```javascript
function validateChineseName(name) {
  const regex = /^[\u4e00-\u9fa5]{1,8}$/;
  return regex.test(name);
}

function validateNumericRange(value, min, max) {
  const num = parseInt(value);
  return !isNaN(num) && num >= min && num <= max;
}
```

#### 10.5.2 业务逻辑验证
```javascript
function validateArmyCreation(data) {
  const errors = [];
  
  if (!validateChineseName(data.name)) {
    errors.push("军团名称必须为1-8个中文字符");
  }
  
  if (!data.general) {
    errors.push("必须选择将领");
  }
  
  if (data.soldiers < 1) {
    errors.push("军团人数必须大于0");
  }
  
  return errors;
}
```

### 10.6 错误处理

#### 10.6.1 异常捕获
```javascript
function safeExecute(operation, errorMessage) {
  try {
    return operation();
  } catch (error) {
    console.error(errorMessage, error);
    alert(errorMessage + "：" + error.message);
    return null;
  }
}
```

#### 10.6.2 数据恢复
```javascript
function loadData() {
  const saved = localStorage.getItem('gekokujo_data_v2');
  if (saved) {
    try {
      gameData = JSON.parse(saved);
      // 数据版本兼容处理
      if (!gameData.products) gameData.products = DEFAULT_DATA.products;
      if (!gameData.provinces) gameData.provinces = DEFAULT_DATA.provinces;
    } catch (e) {
      console.error("数据加载失败，使用默认数据", e);
      gameData = JSON.parse(JSON.stringify(DEFAULT_DATA));
    }
  } else {
    gameData = JSON.parse(JSON.stringify(DEFAULT_DATA));
  }
}
```

---

## 11. 用户界面设计

### 11.1 设计原则

#### 11.1.1 视觉设计
- **主题色彩**：战国风格的棕色系主题
- **字体选择**：微软雅黑，确保中文显示效果
- **图标使用**：Emoji图标，简洁直观
- **布局方式**：卡片式布局，信息层次清晰

#### 11.1.2 交互设计
- **操作反馈**：按钮悬停效果，操作确认提示
- **数据展示**：表格固定表头，滚动查看内容
- **表单设计**：滑条+输入框组合，直观易用
- **错误提示**：红色边框闪烁，错误信息显示

### 11.2 响应式设计

#### 11.2.1 断点设置
- **大屏幕**（>1200px）：4列网格布局
- **中等屏幕**（768px-1200px）：2列网格布局
- **小屏幕**（<768px）：单列布局

#### 11.2.2 适配策略
- **导航栏**：小屏幕下垂直排列
- **表格**：水平滚动确保内容可见
- **模态框**：自适应屏幕大小
- **按钮**：触摸友好的尺寸

### 11.3 界面组件

#### 11.3.1 卡片组件
```css
.card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 3px 15px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  border: 1px solid var(--border-color);
  overflow: hidden;
}
```

#### 11.3.2 表格组件
```css
.table-wrapper {
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

th {
  background: var(--header-bg);
  color: white;
  position: sticky;
  top: 0;
  z-index: 10;
}
```

#### 11.3.3 按钮组件
```css
.btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  margin: 1px;
  transition: all 0.2s;
}

.btn:hover {
  opacity: 0.85;
  transform: translateY(-1px);
}
```

### 11.4 用户体验优化

#### 11.4.1 加载优化
- **懒加载**：大数据表格分页或虚拟滚动
- **缓存策略**：计算结果缓存，避免重复计算
- **异步处理**：大量数据操作使用setTimeout分片

#### 11.4.2 操作优化
- **快捷键**：Enter键登录，ESC键关闭模态框
- **自动保存**：数据修改后自动保存到LocalStorage
- **操作确认**：危险操作需要二次确认

#### 11.4.3 信息展示优化
- **数据格式化**：大数字使用千分位分隔符
- **状态指示**：不同状态用不同颜色标识
- **工具提示**：重要信息提供hover提示

---

## 12. 测试与部署

### 12.1 功能测试

#### 12.1.1 登录系统测试
- **管理员登录**：验证admin代码登录
- **玩家登录**：验证势力代码登录
- **权限验证**：确保不同权限看到不同界面
- **登出功能**：验证登出后需重新登录

#### 12.1.2 数据操作测试
- **CRUD操作**：测试所有数据的增删改查
- **数据验证**：测试各种输入验证规则
- **关联更新**：测试数据关联关系的正确更新
- **边界条件**：测试极值和异常输入

#### 12.1.3 计算系统测试
- **经济计算**：验证各种情况下的经济计算准确性
- **投资系统**：测试投资判定和结果计算
- **回合结算**：验证年度结算的完整性
- **特殊情况**：测试叛乱、负债等特殊情况

### 12.2 兼容性测试

#### 12.2.1 浏览器兼容性
- **Chrome**：主要测试浏览器
- **Firefox**：次要测试浏览器
- **Safari**：Mac用户支持
- **Edge**：Windows用户支持

#### 12.2.2 设备兼容性
- **桌面端**：1920x1080及以上分辨率
- **平板端**：iPad等中等屏幕设备
- **手机端**：基本功能支持，主要为查看

#### 12.2.3 性能测试
- **数据量测试**：大量数据下的性能表现
- **内存使用**：长时间使用的内存占用
- **响应速度**：各种操作的响应时间

### 12.3 部署方案

#### 12.3.1 本地部署
- **文件分发**：直接分发HTML文件
- **使用方式**：双击文件在浏览器中打开
- **数据同步**：通过导出/导入功能手动同步

#### 12.3.2 Web服务器部署
- **静态托管**：上传到Web服务器
- **访问方式**：通过URL访问
- **数据共享**：多人访问同一URL，但数据仍需手动同步

#### 12.3.3 云端部署
- **GitHub Pages**：免费静态网站托管
- **Netlify/Vercel**：现代化静态网站部署
- **自定义域名**：可配置自定义域名访问

### 12.4 维护与更新

#### 12.4.1 版本控制
- **版本号管理**：使用语义化版本号
- **更新日志**：记录每个版本的更新内容
- **兼容性处理**：新版本对旧数据的兼容

#### 12.4.2 问题反馈
- **错误收集**：JavaScript错误的收集和分析
- **用户反馈**：收集用户使用中的问题和建议
- **快速修复**：重要问题的快速修复机制

#### 12.4.3 功能扩展
- **模块化设计**：便于添加新功能模块
- **API预留**：为未来可能的后端集成预留接口
- **数据结构扩展**：支持新字段和新功能的数据结构

---

## 附录

### A. 默认数据示例

#### A.1 势力数据示例
```javascript
{
  id: 'oda',
  name: '织田家',
  lord: '织田信长',
  code: 'oda',
  taxRate: 60,
  industryKoku: 10000,
  agriculture: { points: 30 },
  navy: { points: 15 },
  armament: { points: 25 },
  arsenal: { guns: 100, horses: 50, cannons: 5 },
  soldiers: { idle: 500 },
  money: 50000,
  samurai: [
    { name: '柴田胜家', type: '猛将', martial: 85, civil: 45 },
    { name: '丹羽长秀', type: '智将', martial: 65, civil: 80 }
  ]
}
```

#### A.2 领地数据示例
```javascript
{
  code: 'WEIZH01',
  province: '尾张国',
  name: '春日井郡',
  castle: '清洲城',
  castleLevel: 5,
  baseKoku: 50000,
  product1: '商业街',
  product2: '',
  product3: '',
  developableProduct: '港口',
  owner: 'oda',
  garrison: '织田本队',
  description: '尾张国的中心地带，织田家的根据地。'
}
```

### B. 计算公式汇总

#### B.1 经济计算公式
```
表面石高 = 领地石高 × (1 + 加成系数) + 特产石高 + 整合奖励 + 产业石高
年收入 = 表面石高 × 税率 × 0.4
士兵上限 = (领地石高 ÷ 10000) × 招募系数 + 特产士兵加成
总支出 = 士兵维护费 + 装备维护费 × (1 + 武备修正) + 军团出征费 + 武士俸禄
净收入 = 年收入 - 总支出
```

#### B.2 投资计算公式
```
修正系数 = 1 + (武士属性 - 70) × 1%
成功率 = 50% + (武士属性 - 70)%，限制在5%-95%
获得点数 = 基础点数 × 修正系数 × 结果倍率
```

### C. 技术规格

#### C.1 浏览器要求
- **最低版本**：Chrome 60+, Firefox 55+, Safari 12+, Edge 79+
- **JavaScript**：ES6+支持
- **LocalStorage**：至少5MB存储空间
- **屏幕分辨率**：最低1024x768

#### C.2 性能指标
- **首次加载**：< 3秒
- **操作响应**：< 500ms
- **数据保存**：< 100ms
- **内存占用**：< 100MB

---

**文档结束**

*本文档详细描述了下克上小助手v0.01内测版的完整需求、功能设计和技术实现。如有疑问或需要补充，请联系开发团队。*